---
title: "Participant measures for U-shape"
author: "JÃ¶rn Alexander Quent"
date: "20 October 2018"
output:
  html_document:
    theme: united
    toc: yes
    toc_depth: 6
fontsize: 12pt
geometry: left=2.54cm,right=2.54cm,top=2.54cm,bottom=2.54cm
---


```{r setup, include=FALSE}
# Libraries
library(ggplot2)
library(knitr)
library(plyr)

# Settings
opts_chunk$set(echo = TRUE,
               warning = FALSE,
               message = FALSE,
               eval = TRUE,                     
               fig.width = 10, 
               fig.height = 7, 
               dpi = 300)
opts_knit$set(eval.after = 'fig.cap')
```

# Problem
In the next project, it is our aim to see what the effect of administration of hydrocortisone is one the U-shaped curve we observed in previous experiments. To do, see we measure basal activity in hippocampus and mPFC and examine how this relates to the U-shape. To be able to do this, it is important to have participant-level measures of the U-shape. The aim here is to explore different otions. 

# Loading data from previous experiments
```{r loading_data}
# schemaVR1
load("U:/Projects/schemaVR/report_firstYear/report/data/exp1Data.RData")
combData1 <- combData
# Notes and decision on participants:
# Participant #1: Sligthly different instructions for no-memory trial -> exlcude.
# Participant #1 to #6: Had no familiarisation phase
# Participant #5 and # 15: Second exposure with stimulus -> include.
# Participant #9: No memory trials on trial 1 and 2 because I pressed those accidently -> changed.
combData1[which(combData1$subNum == 9 & (combData1$recallTrial == 1 | combData1$recallTrial == 2)), 'recallNoMemory'] <- 1
# Participant #10: Problems with data and from towel -> no anormalities.
# Participant #13: Had a longer delay (1.5 min)
combData1 <- subset(combData1, subNum != 1)

# schemaVR2
load("U:/Projects/schemaVR/report_firstYear/report/data/exp2Data.RData")
combData2 <- combData
# Notes and decision on participants:
# Participant #20 to #24: Exclude participants because they did the  wrong objLocTargetRating
combData2 <- subset(combData2, subNum >= 25)
# Participant #20 to #27: Foil2 for umbrella was not saved.
# Participant #25 to #27: Rated object 16 at location 1 instead of 14. This value is therefore missing.
# Participant #22: Seen objects twice but is excluded anyway. 
# Participant #26: Check recall microwave because it was correct (it is). The 2nd rating was 100 not 0.
combData2[which(combData2$subNum == 26 & combData2$objNum == 3), 'generalRatingPost'] <- 100

# Combining data from both experiments
dataBothExp <- data.frame(subNum = as.factor(c(combData1$subNum, combData2$subNum)),
                          objLocTargetRating = c(combData1$objLocTargetRating, combData2$objLocTargetRating),
                          accAFC = c(combData1$accAFC, combData2$accAFC),
                          accRecall = c(combData1$accRecall, combData2$accRecall))
```

# Ranking across responses for each participant individually
Here I create a factor by ranking the expectancy values for each participant individually and assigning the label unexpected to all ranked values below 7 and expected to all values over 14. 

```{r}
# Calculating rank for responses for each participant
dataBothExp$postRatingTargetRank <- ddply(dataBothExp, 
                                        c('subNum'), 
                                        summarise, 
                                        objLocTargetRating = objLocTargetRating, 
                                        rank = rank(objLocTargetRating))$rank

# Creating factor based on ranking
dataBothExp$postRatingRankFactor <- 2
dataBothExp$postRatingRankFactor[which(dataBothExp$postRatingTargetRank <= 7)]  <- 1
dataBothExp$postRatingRankFactor[which(dataBothExp$postRatingTargetRank >= 14)] <- 3
dataBothExp$postRatingRankFactor <- factor(dataBothExp$postRatingRankFactor, labels = c("unexpected", "neutral", "expected"))

# Aggregation
postRatingRankFactor_agg <- ddply(dataBothExp,
                                        c('subNum', 'postRatingRankFactor'), 
                                        summarise,
                                        accAFC = mean(accAFC, na.rm = TRUE),
                                        accRecall = mean(accRecall, na.rm = TRUE))

# Plotting
ggplot(postRatingRankFactor_agg, aes(x = postRatingRankFactor, y = accAFC)) +
  geom_boxplot(width = 0.5) +
  geom_point() +  
  geom_line(aes(group = subNum, colour = subNum)) +
  labs(y = 'Mean accuracy (3AFC)', 
       x = "Expectancy", 
       title = 'Relationship with post-encoding ratings') + 
  theme(plot.margin = margin(10, 10, 10, 10),
        legend.position = "none" )

ggplot(postRatingRankFactor_agg, aes(x = postRatingRankFactor, y = accRecall)) +
  geom_boxplot(width = 0.5) +
  geom_point() +  
  geom_line(aes(group = subNum, colour = subNum)) +
  labs(y = 'Mean accuracy (recall)', 
       x = "Expectancy", 
       title = 'Relationship with post-encoding ratings') + 
  theme(plot.margin = margin(10, 10, 10, 10),
        legend.position = "none" )
```

# Ranking across all responses
Here I create a factor by ranking the expectancy values across all responses and assigning the label unexpected to lowest third of ranked values and expected to the highest third of values. 

```{r ranking_all_responses}
# Calculating ranks across all responses
dataBothExp$rankedPostRatings <- rank(dataBothExp$objLocTargetRating)
maxRank     <- max(dataBothExp$rankedPostRatings)
maxRankStep <- maxRank/3

# Creating factor
rankedPostRatingsFactor <- rep('unexpected', length(dataBothExp$objLocTargetRating))
rankedPostRatingsFactor[dataBothExp$rankedPostRatings > maxRankStep & dataBothExp$rankedPostRatings  <= maxRankStep*2] <- 'neutral'
rankedPostRatingsFactor[dataBothExp$rankedPostRatings> maxRankStep*2] <- 'expected'
dataBothExp$rankedPostRatingsFactor <- rankedPostRatingsFactor

# Aggregating
rankedPostRatingsFactor_agg <- ddply(dataBothExp,
                                     c('subNum','rankedPostRatingsFactor'),
                                     summarise, 
                                     accAFC = mean(accAFC, na.rm = TRUE),
                                     accRecall = mean(accRecall, na.rm = TRUE))

# Plotting
ggplot(rankedPostRatingsFactor_agg, aes(x = rankedPostRatingsFactor, y = accAFC)) +
  geom_boxplot(width = 0.5) +
  geom_point() +  
  geom_line(aes(group = subNum, colour = subNum)) +
  labs(y = 'Mean accuracy (AFC)', 
       x = "Expectancy", 
       title = 'Relationship with post-encoding ratings') + 
  theme(plot.margin = margin(10, 10, 10, 10),
        legend.position = "none" )

ggplot(rankedPostRatingsFactor_agg, aes(x = rankedPostRatingsFactor, y = accRecall)) +
  geom_boxplot(width = 0.5) +
  geom_point() +  
  geom_line(aes(group = subNum, colour = subNum)) +
  labs(y = 'Mean accuracy (recall)', 
       x = "Expectancy", 
       title = 'Relationship with post-encoding ratings') + 
  theme(plot.margin = margin(10, 10, 10, 10),
        legend.position = "none" )
```

# Using raw scores
Here I create a factor by assigning the label unexpected to expectancy values below -33 and expected to values over 33. 
```{r raw_scores}
# Creating factor
stepValue <- 200/3
minValue  <- stepValue - 100
postRatingsFactor <- rep('unexpected', length(dataBothExp$objLocTargetRating))
postRatingsFactor[dataBothExp$objLocTargetRating > minValue & dataBothExp$objLocTargetRating  <= minValue + stepValue] <- 'neutral'
postRatingsFactor[dataBothExp$objLocTargetRating > minValue + stepValue] <- 'expected'
dataBothExp$postRatingsFactor <- postRatingsFactor

# Aggregating
postRatingsFactor_agg <- ddply(dataBothExp, 
                               c('subNum','postRatingsFactor'), 
                               summarise, 
                               accAFC = mean(accAFC, na.rm = TRUE), 
                               accRecall = mean(accRecall, na.rm = TRUE))


ggplot(postRatingsFactor_agg, aes(x = postRatingsFactor, y = accAFC)) +
  geom_boxplot(width = 0.5) +
  geom_point() +  
  geom_line(aes(group = subNum, colour = subNum)) +
  labs(y = 'Mean accuracy (AFC)', 
       x = "Expectancy", 
       title = 'Relationship with post-encoding ratings') + 
  theme(plot.margin = margin(10, 10, 10, 10),
        legend.position = "none" )

ggplot(postRatingsFactor_agg, aes(x = postRatingsFactor, y = accRecall)) +
  geom_boxplot(width = 0.5) +
  geom_point() +  
  geom_line(aes(group = subNum, colour = subNum)) +
  labs(y = 'Mean accuracy (recall)', 
       x = "Expectancy", 
       title = 'Relationship with post-encoding ratings') + 
  theme(plot.margin = margin(10, 10, 10, 10),
        legend.position = "none" )
```

# Conclusion
None of the measures above provide reliable participant-level measures of the U-shape. Therefore, it might be important to add another virtual room to increase the number of trials per participant. 