<!DOCTYPE html>
<html lang="en" >

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">


<meta property="og:title" content="Understanding the basics of the general linear model (GLM) in the context of fMRI" />
<meta property="og:description" content="A short post dedicated to understand the idea behind general linear models for functional MRI analysis" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jaquent.github.io/2023/02/understanding-the-basics-of-the-general-linear-model-glm-in-the-context-of-fmri/" />
<meta property="article:published_time" content="2023-02-14T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-02-14T00:00:00+00:00" />



<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Understanding the basics of the general linear model (GLM) in the context of fMRI"/>
<meta name="twitter:description" content="A short post dedicated to understand the idea behind general linear models for functional MRI analysis"/>
<meta name="generator" content="Hugo 0.110.0">


    
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "headline": "Understanding the basics of the general linear model (GLM) in the context of fMRI",
  "url": "https://jaquent.github.io/2023/02/understanding-the-basics-of-the-general-linear-model-glm-in-the-context-of-fmri/",
  "wordCount": "5684",
  "datePublished": "2023-02-14T00:00:00+00:00",
  "dateModified": "2023-02-14T00:00:00+00:00",
  "author": {
    "@type": "Person",
    "name": "Jörn Alexander Quent"
  },
  "keywords": "experiments, GLM, stats, fMRI",
  "description": "A short post dedicated to understand the idea behind general linear models for functional MRI analysis"
}
</script>



    <link rel="canonical" href="https://jaquent.github.io/2023/02/understanding-the-basics-of-the-general-linear-model-glm-in-the-context-of-fmri/">

    <title>Understanding the basics of the general linear model (GLM) in the context of fMRI | Jörn Alexander Quent&#39;s notebook</title>

    
    <!-- combined, minified CSS -->
    
    <link href="https://jaquent.github.io/css/style.0b72f41a0f22d687d912a8e7c945fc14c7a36daee062380f9fae9958e7d17da6.css" rel="stylesheet" integrity="sha256-C3L0Gg8i1ofZEqjnyUX8FMejba7gYjgPn66ZWOfRfaY=" crossorigin="anonymous">
    

    <!-- minified Font Awesome for SVG icons -->
    
    <script defer src="https://jaquent.github.io/js/fontawesome.min.a290d22177f491b8a83b0ee7eb739224c57ab052d8fab69d8f52aab860e42027.js" integrity="sha256-opDSIXf0kbioOw7n63OSJMV6sFLY&#43;radj1KquGDkICc=" crossorigin="anonymous"></script>

    <!-- RSS 2.0 feed -->
    

    



<link rel="stylesheet" href="https://jaquent.github.io/css/syntax.css">


<style>
 
pre, .chroma {
  background-color: #2d2d2d !important;
  margin: 2px 0 !important;
  padding: 2px 0 !important;  
  border: 1px solid #2d2d2d !important;
  border-radius: 4px !important;
  overflow-x: auto !important;
  max-width: 100% !important;
  line-height: 1 !important;
  position: relative;  
}

 
pre code, .chroma .code {
  display: block !important;
  color: #f8f8f2 !important;
  background-color: transparent !important;
  font-size: 14px !important;
  font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace !important;
  line-height: 1.4 !important;  
  padding: 0 15px !important;  
  margin: 0 !important;
}

 
.copy-code-btn {
  position: absolute !important;
  top: 4px !important;
  right: 4px !important;
  padding: 3px 8px !important;
  font-size: 11px !important;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
  background-color: #555 !important;
  color: white !important;
  border: none !important;
  border-radius: 3px !important;
  cursor: pointer !important;
  opacity: 0.6 !important;
  transition: opacity 0.2s ease !important;
  z-index: 100 !important;
}

.copy-code-btn:hover {
  opacity: 1 !important;
  background-color: #666 !important;
}

 
pre:hover .copy-code-btn,
.chroma:hover .copy-code-btn {
  opacity: 0.8 !important;
}
</style>


<script>
document.addEventListener('DOMContentLoaded', function() {
  
  function findCodeContainer(container) {
    
    
    
    const codeColumn = container.querySelector('.lntd:last-child');
    if (codeColumn) {
      const codePre = codeColumn.querySelector('pre:not(.lnt)');
      if (codePre) return codePre;
      return codeColumn.querySelector('pre, code, .code') || codeColumn;
    }
    
    
    const allPres = container.querySelectorAll('pre');
    for (let pre of allPres) {
      if (!pre.classList.contains('lnt')) {
        return pre;
      }
    }
    
    
    const codeElement = container.querySelector('code');
    if (codeElement) return codeElement;
    
    
    return container;
  }
  
  
  function extractCodeText(container) {
    const codeContainer = findCodeContainer(container);
    
    
    let rawText = codeContainer.textContent || codeContainer.innerText;
    
    
    rawText = rawText.replace(/^\s*\d+\s*/gm, '');
    
    
    rawText = rawText.trim();
    
    return rawText;
  }
  
  
  function addCopyButton(container) {
    
    if (container.querySelector('.copy-code-btn')) {
      return;
    }
    
    
    if (container.closest('.lntd') && container !== document.querySelector('.chroma')) {
      return;
    }
    
    
    const button = document.createElement('button');
    button.className = 'copy-code-btn';
    button.textContent = 'Copy';
    button.title = 'Copy to clipboard';
    
    
    container.style.position = 'relative';
    container.appendChild(button);
    
    
    const codeText = extractCodeText(container);
    
    
    console.log('Code extracted:', codeText.substring(0, 50) + '...');
    
    
    button.addEventListener('click', async (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      try {
        await navigator.clipboard.writeText(codeText);
        button.textContent = '✓ Copied!';
        setTimeout(() => button.textContent = 'Copy', 2000);
      } catch (err) {
        console.error('Copy failed:', err);
        button.textContent = '✗ Error';
        setTimeout(() => button.textContent = 'Copy', 2000);
      }
    });
  }
  
  
  
  const chromaContainers = document.querySelectorAll('.chroma:not(.lntd .chroma)');
  
  if (chromaContainers.length > 0) {
    chromaContainers.forEach(addCopyButton);
  } else {
    
    const preElements = document.querySelectorAll('pre:not(.lnt):not(td pre)');
    preElements.forEach(addCopyButton);
  }
});
</script>

<script src="//yihui.org/js/math-code.js"></script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>


<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ [\'$\',\'$\'], ["\\\\(","\\\\)"] ],
            displayMath: [ [\'$$\',\'$$\'], ["\\\\[","\\\\]"] ],
            processEscapes: true,
            processEnvironments: true
        },
        // Center justify equations in code and markdown cells. Elsewhere
        // we use CSS to left justify single line equations in code cells.
        displayAlign: \'center\',
        "HTML-CSS": {
            styles: {\'.MathJax_Display\': {"margin": 0}},
            linebreaks: { automatic: true }
        }
    });
</script>
 
  </head>

  <body>

    
    <div class="blog-masthead">
      <div class="container">
        <nav class="nav blog-nav">
          <a class="nav-link " href="https://jaquent.github.io/">Home</a>
          
          <a class="nav-link" href="/about/" title="">About</a>
          
          
          <a class="nav-link" href="https://jaquent.me/" title="">jaquent.me</a>
          
        </nav>
      </div>
    </div>
    

    
    
    <header class="blog-header">
      <div class="container">
        <h1 class="blog-title" dir="auto"><a href="https://jaquent.github.io/" rel="home">Jörn Alexander Quent's notebook</a></h1>
        <p class="lead blog-description" dir="auto">where I share semi-interesting stuff from my work</p>
      </div>
    </header>
    
    

    
    <div class="container">
      <div class="row">
        <div class="col-sm-8 blog-main">

          


<article class="blog-post">
  <header>
    <h2 class="blog-post-title" dir="auto"><a href="https://jaquent.github.io/2023/02/understanding-the-basics-of-the-general-linear-model-glm-in-the-context-of-fmri/">Understanding the basics of the general linear model (GLM) in the context of fMRI</a></h2>
    <p class="blog-post-meta">
<time datetime="2023-02-14T00:00:00Z">Tue Feb 14, 2023</time>
 in 
<span class="fas fa-folder" aria-hidden="true"></span>&nbsp;<a href="/categories/experiments/" rel="category tag">experiments</a>


<span class="fas fa-tag" aria-hidden="true"></span>&nbsp;<a href="/tags/glm/" rel="tag">GLM</a>, <a href="/tags/stats/" rel="tag">stats</a>, <a href="/tags/fmri/" rel="tag">fMRI</a>

</p>
  </header>
  <ul>
<li><a href="#prelude" id="toc-prelude">Prelude</a></li>
<li><a href="#sources-that-i-found-useful"
id="toc-sources-that-i-found-useful">Sources that I found useful</a></li>
<li><a href="#general-libraries" id="toc-general-libraries">General
libraries</a></li>
<li><a href="#simple-linear-regression"
id="toc-simple-linear-regression">Simple linear regression</a></li>
<li><a href="#multiple-linear-regression"
id="toc-multiple-linear-regression">Multiple linear regression</a></li>
<li><a href="#special-cases" id="toc-special-cases">Special cases</a>
<ul>
<li><a href="#one-sample-t-test" id="toc-one-sample-t-test">One sample
t-test</a></li>
<li><a href="#two-sample-t-test" id="toc-two-sample-t-test">Two sample
t-test</a></li>
<li><a href="#paired-t-test" id="toc-paired-t-test">Paired t-test</a></li>
<li><a href="#two-way-anova" id="toc-two-way-anova">Two-way ANOVA</a></li>
</ul>
</li>
<li><a href="#does-the-contrast-weighting-matter-for-the-test-statistics"
id="toc-does-the-contrast-weighting-matter-for-the-test-statistics">Does
the contrast weighting matter for the test-statistics?</a></li>
<li><a href="#covariance-matrix-of-the-residuals"
id="toc-covariance-matrix-of-the-residuals">Covariance matrix of the
residuals</a></li>
<li><a href="#a-example-design-matrix-for-fmri"
id="toc-a-example-design-matrix-for-fmri">A example design matrix for
fMRI</a></li>
<li><a href="#multiple-testing-problem"
id="toc-multiple-testing-problem">Multiple testing problem</a>
<ul>
<li><a href="#calculate-fwe" id="toc-calculate-fwe">Calculate FWE</a></li>
<li><a href="#fwe-correction" id="toc-fwe-correction">FWE correction</a>
<ul>
<li><a href="#random-field-theory" id="toc-random-field-theory">Random field
theory</a></li>
<li><a href="#permutation-tests" id="toc-permutation-tests">Permutation
tests</a></li>
</ul>
</li>
<li><a href="#fdr" id="toc-fdr">FDR</a></li>
</ul>
</li>
<li><a href="#conclusion" id="toc-conclusion">Conclusion</a></li>
<li><a href="#glossary" id="toc-glossary">Glossary</a></li>
</ul>
<h1 id="prelude">Prelude</h1>
<p>I was revisiting some of the basics surrounding fMRI especially the GLM
and contrasts. I’ve tried to find code examples and equations but I
didn’t really find anything for R. While I found the accessible explanations
and equations in Poldrack et al. (2011) and more advanced concepts in
Kutner (2005), I didn’t find code examples. So in the spirit of Heinrich
von Kleist, who pointed out your understanding will get much better if
you try to explain things yourself, I am creating minimalist code
examples myself while showing that those fit the results that I get from
R’s built-in functions (e.g. t-tests).</p>
<p>Note I am not expert in this field and I might have gotten some
terminology or equations wrong. If you find a mistake please find my
e-mail and tell me about it. Think of this as me sharing my cheat sheet,
which I would use when ever I have to refresh my knowledge. I am sharing
this because I thought some one else might get stuck (like me) trying to understand
some of the concepts. For details I first recommend
taking a look at Poldrack’s book (especially the appendix) and then
Kutner. Generally, the examples used here are only illustrations and
might not be the best approximations of actual brain data (e.g. smoothness etc.).</p>
<p>Last note: The contrasts and design matrices are only valid
for the exact ordering of the data so you can only use those if your
ordering of the data is the same.</p>
<h1 id="sources-that-i-found-useful">Sources that I found useful</h1>
<ul>
<li>Statistical background:
<ul>
<li>Poldrack, R. A., Mumford, J. A., &amp; Nichols, T. E. (2011). Handbook
of functional MRI data analysis. Cambridge University Press.</li>
<li>Kutner, M. H. (Ed.). (2005). Applied linear statistical models (5th
ed). McGraw-Hill Irwin.</li>
</ul>
</li>
<li>For more on models &amp; their design matrices:
<a href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/GLM">https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/GLM</a></li>
<li>For reasoning behind the concept rank:
<a href="https://www.youtube.com/watch?v=uQhTuRlWMxw&amp;ab_channel=3Blue1Brown">https://www.youtube.com/watch?v=uQhTuRlWMxw&amp;ab_channel=3Blue1Brown</a>
(because it’s used for F-tests and more)</li>
<li>For understanding p-values (always good to repeat this):
<a href="https://correlaid.org/en/blog/understand-p-values/">https://correlaid.org/en/blog/understand-p-values/</a></li>
</ul>
<h1 id="general-libraries">General libraries</h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># Install via devtools::install_github(&#34;JAQuent/assortedRFunctions&#34;, upgrade = &#34;never&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="nf">library</span><span class="p">(</span><span class="n">assortedRFunctions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">library</span><span class="p">(</span><span class="n">Matrix</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">library</span><span class="p">(</span><span class="n">lattice</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">library</span><span class="p">(</span><span class="n">soundgen</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">library</span><span class="p">(</span><span class="n">cowplot</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">library</span><span class="p">(</span><span class="n">knitr</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="simple-linear-regression">Simple linear regression</h1>
<p>Starting off with something very easy: simple linear regression as
viewed through the GLM-framework. I start with generating fake data.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># Set seed</span>
</span></span><span class="line"><span class="cl"><span class="nf">set.seed</span><span class="p">(</span><span class="m">102</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Fake data parameters</span>
</span></span><span class="line"><span class="cl"><span class="n">n</span>     <span class="o">&lt;-</span> <span class="m">100</span>
</span></span><span class="line"><span class="cl"><span class="n">beta0</span> <span class="o">&lt;-</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">beta1</span> <span class="o">&lt;-</span> <span class="m">5</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create fake data</span>
</span></span><span class="line"><span class="cl"><span class="n">x</span> <span class="o">&lt;-</span> <span class="nf">runif</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Y</span> <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">beta0</span> <span class="o">+</span> <span class="n">beta1</span><span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> <span class="n">ncol</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Plot data</span>
</span></span><span class="line"><span class="cl"><span class="nf">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/post/2023-02-14-understanding-the-basics-of-the-general-linear-model-glm-in-the-context-of-fmri/figure-gfm/s_l_r_fake_data-1.png" alt=""><!-- --></p>
<p>The data is illustrated in a scatter plot. When analysing the data using
<code>lm()</code> I get the following results</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># Analysis using lm()</span>
</span></span><span class="line"><span class="cl"><span class="n">lm_model</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">Y</span> <span class="o">~</span> <span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">summary</span><span class="p">(</span><span class="n">lm_model</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>## 
## Call:
## lm(formula = Y ~ x)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -2.49576 -0.61718 -0.08426  0.60519  2.07532 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)   1.8667     0.2093   8.918 2.69e-14 ***
## x             5.1762     0.3560  14.540  &lt; 2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 0.9751 on 98 degrees of freedom
## Multiple R-squared:  0.6833, Adjusted R-squared:   0.68 
## F-statistic: 211.4 on 1 and 98 DF,  p-value: &lt; 2.2e-16
</code></pre>
<p>which gives me an estimate of the intercept &amp; slope.</p>
<p>The equation corresponding to the model above can be expressed as</p>
<p>$$ Y = \beta_{0}+ \beta_{1}x_{1}+\epsilon $$ the model fit to the data
via <code>lm()</code> estimated that $\beta_0$ = 1.8667 and $\beta_1$ = 5.1762.</p>
<p>While, the model equation is useful in some ways (e.g. easy to
understand) it is also highly specific and only pertains to models that
exactly like this one, which have an intercept and a slope. When
conceptualising everything in the GLM-framework, we can do something much more
powerful as we can generally write this model as</p>
<p>$$ Y = X\beta + \epsilon $$</p>
<p>which is the a valid description for all the different kinds of models &amp;
tests that fall under the GLM umbrella. Therefore we can use the same
notation and tricks to deal with a wide variety of statistical problems.
All that we have to do to analyse data following this notation is to
create the design matrix $X$.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># Calculate the design matrix </span>
</span></span><span class="line"><span class="cl"><span class="n">X</span> <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">x</span><span class="p">),</span> <span class="n">ncol</span> <span class="o">=</span> <span class="m">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Visualise design matrix</span>
</span></span><span class="line"><span class="cl"><span class="nf">dispDesignMatrix</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">title</span><span class="p">(</span><span class="n">main</span> <span class="o">=</span> <span class="s">&#39;Simple linear regression design matrix&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/post/2023-02-14-understanding-the-basics-of-the-general-linear-model-glm-in-the-context-of-fmri/figure-gfm/s_l_r_design_matrix-1.png" alt=""><!-- --></p>
<p>In the simple example above our design matrix has 1s for the intercept
(i.e. $\beta_0$) and the values of our variable $x$ for the second
column representing $\beta_1$.</p>
<p>When we have this, estimating the $\beta$s is very simple, assuming that
$X^\intercal X$ is invertible (for an inverse of $X^\intercal X$ to
exists $X$ must have full column rank, see Glossary for explanation or
the YouTube video that I added), using this equation:</p>
<p>$$ \hat{\beta} = (X^\intercal X)^{-1} X^\intercal Y$$</p>
<p>Note that is what we get if we premultiply $Y = X\beta + \epsilon$ by
$X^\intercal$:</p>
<p>$$ X^\intercal Y = X^\intercal X\beta$$ which is a neat trick that
allows us to invert the matrix.</p>
<p>In R this would look like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># Estimate betas via Ordinary Least Squares (OLS) estimation</span>
</span></span><span class="line"><span class="cl"><span class="n">B</span> <span class="o">&lt;-</span> <span class="nf">solve</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">%*%</span> <span class="n">X</span><span class="p">)</span> <span class="o">%*%</span> <span class="nf">t</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">Y</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Fortunately, using this equation we get the same values for $\beta_0$ =
1.8667 and $\beta_0$ = 5.1762.</p>
<p>Quick side note: <code>solve()</code> can only invert matrices that are square
(e.g. 3 x 3) directly</p>
<p>$$ A = \begin{bmatrix} 2 &amp; 5 &amp; 3 \ 4 &amp; 0 &amp; 8 \ 1 &amp; 3 &amp; 0 \end{bmatrix} $$</p>
<p>in this case</p>
<p>$$ A^{-1} = solve(A) = (A^\intercal A)^{-1} A^\intercal$$</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">A</span>          <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">8</span><span class="p">,</span> <span class="m">0</span><span class="p">),</span> <span class="n">ncol</span> <span class="o">=</span> <span class="m">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">A_inverse1</span> <span class="o">&lt;-</span> <span class="nf">solve</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">A_inverse2</span> <span class="o">&lt;-</span> <span class="nf">solve</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">%*%</span> <span class="n">A</span><span class="p">)</span> <span class="o">%*%</span> <span class="nf">t</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Note A_inverse1 == A_inverse2 actually returns FALSE but the values are the same, which is due to rounding. </span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>So the trick of transposing and then multiplying the matrix with itself
is something we have to use because our design matrix $X$ are typically
not square.</p>
<p>Moving on, estimates for $Y$ can be calculated like this</p>
<p>$$ \hat{Y} =  \hat{\beta_{0}} + \hat{\beta_{1}}x_{1}$$</p>
<p>or in matrix notation</p>
<p>$$ \hat{Y} = X\beta $$</p>
<p>In R this works simply by</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">Y_hat</span> <span class="o">&lt;-</span> <span class="n">X</span> <span class="o">%*%</span> <span class="n">B</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The residuals can be obtained like this</p>
<p>$$ e = Y - \hat{Y} $$</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">E</span> <span class="o">&lt;-</span> <span class="n">Y</span> <span class="o">-</span> <span class="n">Y_hat</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>To calculate the test statistics like $t$ we also need an estimation of
the variance of the residuals</p>
<p>$$ \hat{\sigma}^2 =  \frac{e^\intercal e}{N-p} $$ where $N$ is the
number of rows and $p$ is the number of columns of the design matrix
$X$.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">p</span> <span class="o">&lt;-</span> <span class="nf">ncol</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">N</span> <span class="o">&lt;-</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">resid_var</span> <span class="o">&lt;-</span> <span class="nf">as.numeric</span><span class="p">((</span><span class="nf">t</span><span class="p">(</span><span class="n">E</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">E</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="n">p</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In our case $\hat{\sigma}^2$ is 0.9508.</p>
<p>With the help of contrasts that are row-vectors with length $p$ we can
test hypotheses as t-tests (or even as F-tests).</p>
<p>For instance, if we want to test if the intercept ($\beta_0$) is zero
i.e. $H_o: \beta_0 = 0$, we can use the following contrast</p>
<p>$$ con_1 = \begin{bmatrix} 1 &amp; 0\end{bmatrix}$$ If we want to test if
our slope ($\beta_1$) is zero i.e. $H_o: \beta_1 = 0$, we use the
following contrast:</p>
<p>$$ con_2 = \begin{bmatrix} 0 &amp; 1\end{bmatrix}$$ Both hypotheses can be
expressed more generally as $H_0: c\beta =0$. In R, we simply need to do</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">con1</span> <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">),</span> <span class="n">ncol</span> <span class="o">=</span> <span class="m">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">con2</span> <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> <span class="n">ncol</span> <span class="o">=</span> <span class="m">2</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The $t$-statistic is then calculated by</p>
<p>$$  t = \frac{con\hat{\beta}}{\sqrt{con(X^\intercal X)^{-1}con^\intercal \hat{\sigma}^2} }$$</p>
<p>This looks more scary then it is. The numerator in case for $con_1$ is
simply our $\beta_0$ estimate.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">numerator</span> <span class="o">&lt;-</span> <span class="n">con1</span> <span class="o">%*%</span> <span class="n">B</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>$c_1\hat{\beta}$ = 1.8667. The denominator is the standard error of the
estimate. Which can be calculated by</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">denominator</span> <span class="o">&lt;-</span> <span class="nf">sqrt</span><span class="p">(</span><span class="n">con1</span> <span class="o">%*%</span> <span class="nf">solve</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">%*%</span> <span class="n">X</span><span class="p">)</span> <span class="o">%*%</span> <span class="nf">t</span><span class="p">(</span><span class="n">con1</span><span class="p">)</span> <span class="o">*</span> <span class="n">resid_var</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>so $\sqrt{con_1(X^\intercal X)^{-1}con_1^\intercal \hat{\sigma}^2}$ is
0.2093.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">t1</span> <span class="o">&lt;-</span> <span class="n">numerator</span><span class="o">/</span><span class="n">denominator</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>So like above when calculated with <code>lm()</code> $t$ = 8.9182.</p>
<p>Just to demonstrate, we also get the correct values for our second
contrast:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">numerator</span>   <span class="o">&lt;-</span> <span class="n">con2</span> <span class="o">%*%</span> <span class="n">B</span>
</span></span><span class="line"><span class="cl"><span class="n">denominator</span> <span class="o">&lt;-</span> <span class="nf">sqrt</span><span class="p">(</span><span class="n">con2</span> <span class="o">%*%</span> <span class="nf">solve</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">%*%</span> <span class="n">X</span><span class="p">)</span> <span class="o">%*%</span> <span class="nf">t</span><span class="p">(</span><span class="n">con2</span><span class="p">)</span> <span class="o">*</span> <span class="n">resid_var</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">t2</span>          <span class="o">&lt;-</span> <span class="n">numerator</span><span class="o">/</span><span class="n">denominator</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>$t$ = 14.54.</p>
<h1 id="multiple-linear-regression">Multiple linear regression</h1>
<p>Within the GLM-framework, we can also run multiple regression models and
most importantly F-tests.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># Set seed</span>
</span></span><span class="line"><span class="cl"><span class="nf">set.seed</span><span class="p">(</span><span class="m">102</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Fake data parameters</span>
</span></span><span class="line"><span class="cl"><span class="n">n</span>     <span class="o">&lt;-</span> <span class="m">100</span>
</span></span><span class="line"><span class="cl"><span class="n">beta0</span> <span class="o">&lt;-</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">beta1</span> <span class="o">&lt;-</span> <span class="m">5</span>
</span></span><span class="line"><span class="cl"><span class="n">beta2</span> <span class="o">&lt;-</span> <span class="m">0.4</span>
</span></span><span class="line"><span class="cl"><span class="n">beta3</span> <span class="o">&lt;-</span> <span class="m">-4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create fake data</span>
</span></span><span class="line"><span class="cl"><span class="n">x1</span> <span class="o">&lt;-</span> <span class="nf">runif</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">x2</span> <span class="o">&lt;-</span> <span class="nf">runif</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">x3</span> <span class="o">&lt;-</span> <span class="nf">runif</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Y</span>  <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">beta0</span> <span class="o">+</span> <span class="n">beta1</span><span class="o">*</span><span class="n">x1</span> <span class="o">+</span> <span class="n">beta2</span><span class="o">*</span><span class="n">x2</span> <span class="o">+</span> <span class="n">beta3</span><span class="o">*</span><span class="n">x3</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> <span class="n">ncol</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># Analysis using lm()</span>
</span></span><span class="line"><span class="cl"><span class="n">lm_model</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">Y</span> <span class="o">~</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span> <span class="o">+</span> <span class="n">x3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">summary</span><span class="p">(</span><span class="n">lm_model</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>## 
## Call:
## lm(formula = Y ~ x1 + x2 + x3)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -2.2840 -0.6754 -0.0352  0.7310  2.2748 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)   2.2686     0.3515   6.454 4.43e-09 ***
## x1            4.6536     0.3740  12.442  &lt; 2e-16 ***
## x2            0.2280     0.3633   0.628    0.532    
## x3           -4.0781     0.3800 -10.732  &lt; 2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 1.02 on 96 degrees of freedom
## Multiple R-squared:  0.741,  Adjusted R-squared:  0.7329 
## F-statistic: 91.55 on 3 and 96 DF,  p-value: &lt; 2.2e-16
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># Calculate the design matrix </span>
</span></span><span class="line"><span class="cl"><span class="n">X</span> <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">),</span> <span class="n">ncol</span> <span class="o">=</span> <span class="m">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Visualise design matrix</span>
</span></span><span class="line"><span class="cl"><span class="nf">dispDesignMatrix</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">title</span><span class="p">(</span><span class="n">main</span> <span class="o">=</span> <span class="s">&#39;Multiple linear regression design matrix&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/post/2023-02-14-understanding-the-basics-of-the-general-linear-model-glm-in-the-context-of-fmri/figure-gfm/m_l_r_design_matrix-1.png" alt=""><!-- --></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># Estimate betas via Ordinary Least Squares (OLS) estimation</span>
</span></span><span class="line"><span class="cl"><span class="n">B</span> <span class="o">&lt;-</span> <span class="nf">solve</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">%*%</span> <span class="n">X</span><span class="p">)</span> <span class="o">%*%</span> <span class="nf">t</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">Y</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Again we get the same values as with <code>lm()</code> 2.2686, 4.6536, 0.228,
-4.0781.</p>
<p>If we want to test $H_0: \beta_1 = \beta_2 = \beta_3 = 0$ or in other
words if any of the $\beta$s that are not the intercept are different
from zero, then we can use the following contrast:</p>
<p>$$ con = \begin{bmatrix} 0 &amp; 1 &amp; 0 &amp; 0 \ 0 &amp; 0 &amp; 1 &amp; 0 \ 0 &amp; 0 &amp; 0 &amp; 1\end{bmatrix} $$</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># Quick &amp; dirty way to create the contrast is to remove the first row of an identity matrix</span>
</span></span><span class="line"><span class="cl"><span class="n">con</span> <span class="o">&lt;-</span> <span class="nf">diag</span><span class="p">(</span><span class="m">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">con</span> <span class="o">&lt;-</span> <span class="n">con[</span><span class="m">-1</span><span class="p">,</span><span class="n">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The test statistics is then calculated by</p>
<p>$$ F = (con\hat{\beta})^\intercal [rcon(\hat{Cov}(\hat{\beta}))con^\intercal]^{-1}(con\hat{\beta})$$</p>
<p>where $r$ is the rank of the contrast matrix/vector $con$,</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">r</span> <span class="o">&lt;-</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="nf">rankMatrix</span><span class="p">(</span><span class="n">con</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>which in our case is 3 as there are 3 independent columns in $con$ and</p>
<p>$$ \hat{Cov}(\hat{\beta}) = (X^\intercal X)^{-1}\hat{\sigma}^2 $$</p>
<p>Now we can calculate our F-value by hand:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># Calculate residual variance</span>
</span></span><span class="line"><span class="cl"><span class="n">Y_hat</span> <span class="o">&lt;-</span> <span class="n">X</span> <span class="o">%*%</span> <span class="n">B</span>
</span></span><span class="line"><span class="cl"><span class="n">E</span> <span class="o">&lt;-</span> <span class="n">Y</span> <span class="o">-</span> <span class="n">Y_hat</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">&lt;-</span> <span class="nf">ncol</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">N</span> <span class="o">&lt;-</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">resid_var</span> <span class="o">&lt;-</span> <span class="nf">as.numeric</span><span class="p">((</span><span class="nf">t</span><span class="p">(</span><span class="n">E</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">E</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="n">p</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Covariance of beta</span>
</span></span><span class="line"><span class="cl"><span class="n">Cov_hat_beta</span> <span class="o">&lt;-</span> <span class="nf">solve</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="n">resid_var</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Calculate F- test</span>
</span></span><span class="line"><span class="cl"><span class="n">F_stat</span> <span class="o">&lt;-</span> <span class="nf">t</span><span class="p">(</span><span class="n">con</span> <span class="o">%*%</span> <span class="n">B</span><span class="p">)</span> <span class="o">%*%</span> <span class="nf">solve</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">con</span> <span class="o">%*%</span> <span class="n">Cov_hat_beta</span> <span class="o">%*%</span> <span class="nf">t</span><span class="p">(</span><span class="n">con</span><span class="p">))</span> <span class="o">%*%</span> <span class="p">(</span><span class="n">con</span> <span class="o">%*%</span> <span class="n">B</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In this case, $F$ = 91.5454, which can matches the one that <code>lm()</code> spits
out.</p>
<h1 id="special-cases">Special cases</h1>
<p>The GLM is also powerful not only for the these regression models but
also for a number of special cases that we often use for imaging.</p>
<h2 id="one-sample-t-test">One sample t-test</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># Fake data parameters</span>
</span></span><span class="line"><span class="cl"><span class="n">n</span>     <span class="o">&lt;-</span> <span class="m">100</span>
</span></span><span class="line"><span class="cl"><span class="n">beta0</span> <span class="o">&lt;-</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">beta1</span> <span class="o">&lt;-</span> <span class="m">5</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create fake data</span>
</span></span><span class="line"><span class="cl"><span class="n">x</span> <span class="o">&lt;-</span> <span class="nf">runif</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Y</span> <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">beta0</span> <span class="o">+</span> <span class="n">beta1</span><span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> <span class="n">ncol</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create design matrix</span>
</span></span><span class="line"><span class="cl"><span class="n">X</span> <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)),</span> <span class="n">ncol</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Estimate betas</span>
</span></span><span class="line"><span class="cl"><span class="n">B</span> <span class="o">&lt;-</span> <span class="nf">solve</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">%*%</span> <span class="n">X</span><span class="p">)</span> <span class="o">%*%</span> <span class="nf">t</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">Y</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Calculate residual variance</span>
</span></span><span class="line"><span class="cl"><span class="n">Y_hat</span> <span class="o">&lt;-</span> <span class="n">X</span> <span class="o">%*%</span> <span class="n">B</span>
</span></span><span class="line"><span class="cl"><span class="n">E</span> <span class="o">&lt;-</span> <span class="n">Y</span> <span class="o">-</span> <span class="n">Y_hat</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">&lt;-</span> <span class="nf">ncol</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">N</span> <span class="o">&lt;-</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">resid_var</span> <span class="o">&lt;-</span> <span class="nf">as.numeric</span><span class="p">((</span><span class="nf">t</span><span class="p">(</span><span class="n">E</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">E</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="n">p</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Contrast</span>
</span></span><span class="line"><span class="cl"><span class="n">con</span> <span class="o">&lt;-</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Calculate the t value</span>
</span></span><span class="line"><span class="cl"><span class="n">numerator</span>   <span class="o">&lt;-</span> <span class="n">con</span> <span class="o">%*%</span> <span class="n">B</span>
</span></span><span class="line"><span class="cl"><span class="n">denominator</span> <span class="o">&lt;-</span> <span class="nf">sqrt</span><span class="p">(</span><span class="n">con</span> <span class="o">%*%</span> <span class="nf">solve</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">%*%</span> <span class="n">X</span><span class="p">)</span> <span class="o">%*%</span> <span class="nf">t</span><span class="p">(</span><span class="n">con</span><span class="p">)</span> <span class="o">*</span> <span class="n">resid_var</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">t_value</span>     <span class="o">&lt;-</span> <span class="n">numerator</span><span class="o">/</span><span class="n">denominator</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In this model $\beta_1 = mean(Y)$ = 4.4319552. As calculated when we use
<code>t.test()</code>, the $t$-value is 26.2878. $H_0: \beta_1 = 0$.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="nf">t.test</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>## 
##  One Sample t-test
## 
## data:  Y
## t = 26.288, df = 99, p-value &lt; 2.2e-16
## alternative hypothesis: true mean is not equal to 0
## 95 percent confidence interval:
##  4.097429 4.766481
## sample estimates:
## mean of x 
##  4.431955
</code></pre>
<h2 id="two-sample-t-test">Two sample t-test</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># Generate new data</span>
</span></span><span class="line"><span class="cl"><span class="n">y1</span> <span class="o">&lt;-</span> <span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">y2</span> <span class="o">&lt;-</span> <span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="m">0.3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Y</span>  <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create design matrix</span>
</span></span><span class="line"><span class="cl"><span class="n">X</span> <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">0</span><span class="p">),</span> <span class="n">each</span> <span class="o">=</span> <span class="n">n</span><span class="p">),</span> <span class="nf">rep</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">),</span> <span class="n">each</span> <span class="o">=</span> <span class="n">n</span><span class="p">)),</span> <span class="n">ncol</span> <span class="o">=</span> <span class="m">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Display design matrix</span>
</span></span><span class="line"><span class="cl"><span class="nf">dispDesignMatrix</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">title</span><span class="p">(</span><span class="n">main</span> <span class="o">=</span> <span class="s">&#39;Two sample t-test design matrix&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/post/2023-02-14-understanding-the-basics-of-the-general-linear-model-glm-in-the-context-of-fmri/figure-gfm/two_sample_t_test1-1.png" alt=""><!-- --></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># Estimate betas</span>
</span></span><span class="line"><span class="cl"><span class="n">B</span> <span class="o">&lt;-</span> <span class="nf">solve</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">%*%</span> <span class="n">X</span><span class="p">)</span> <span class="o">%*%</span> <span class="nf">t</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">Y</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Calculate residual variance</span>
</span></span><span class="line"><span class="cl"><span class="n">Y_hat</span> <span class="o">&lt;-</span> <span class="n">X</span> <span class="o">%*%</span> <span class="n">B</span>
</span></span><span class="line"><span class="cl"><span class="n">E</span> <span class="o">&lt;-</span> <span class="n">Y</span> <span class="o">-</span> <span class="n">Y_hat</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">&lt;-</span> <span class="nf">ncol</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">N</span> <span class="o">&lt;-</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">resid_var</span> <span class="o">&lt;-</span> <span class="nf">as.numeric</span><span class="p">((</span><span class="nf">t</span><span class="p">(</span><span class="n">E</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">E</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="n">p</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Contrast</span>
</span></span><span class="line"><span class="cl"><span class="n">con</span> <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">-1</span><span class="p">),</span> <span class="n">ncol</span> <span class="o">=</span> <span class="m">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Calculate the t value</span>
</span></span><span class="line"><span class="cl"><span class="n">numerator</span>   <span class="o">&lt;-</span> <span class="n">con</span> <span class="o">%*%</span> <span class="n">B</span>
</span></span><span class="line"><span class="cl"><span class="n">denominator</span> <span class="o">&lt;-</span> <span class="nf">sqrt</span><span class="p">(</span><span class="n">con</span> <span class="o">%*%</span> <span class="nf">solve</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">%*%</span> <span class="n">X</span><span class="p">)</span> <span class="o">%*%</span> <span class="nf">t</span><span class="p">(</span><span class="n">con</span><span class="p">)</span> <span class="o">*</span> <span class="n">resid_var</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">t_value</span>     <span class="o">&lt;-</span> <span class="n">numerator</span><span class="o">/</span><span class="n">denominator</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In this model $\beta_1 = mean(y_1)$ and $\beta_2 = mean(y_2)$ which are
-0.0807, 0.2204 (the group averages). As calculated with <code>t.test()</code>, the
$t$-value is -2.3043. $H_0: \beta_1 - \beta_2 = 0$.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="nf">t.test</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">var.equal</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>## 
##  Two Sample t-test
## 
## data:  y1 and y2
## t = -2.3043, df = 198, p-value = 0.02224
## alternative hypothesis: true difference in means is not equal to 0
## 95 percent confidence interval:
##  -0.55875369 -0.04341614
## sample estimates:
##   mean of x   mean of y 
## -0.08068517  0.22039974
</code></pre>
<h2 id="paired-t-test">Paired t-test</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># Fake data</span>
</span></span><span class="line"><span class="cl"><span class="n">n</span>  <span class="o">&lt;-</span> <span class="m">20</span>
</span></span><span class="line"><span class="cl"><span class="n">y1</span> <span class="o">&lt;-</span> <span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">y2</span> <span class="o">&lt;-</span> <span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="m">0.3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Y</span>  <span class="o">&lt;-</span> <span class="nf">rep</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">n</span> <span class="o">*</span> <span class="m">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Y</span><span class="nf">[seq</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">to</span> <span class="o">=</span> <span class="n">n</span><span class="o">*</span><span class="m">2</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="m">2</span><span class="p">)</span><span class="n">]</span> <span class="o">&lt;-</span> <span class="n">y1</span>
</span></span><span class="line"><span class="cl"><span class="n">Y</span><span class="nf">[seq</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="m">2</span><span class="p">,</span> <span class="n">to</span> <span class="o">=</span> <span class="n">n</span><span class="o">*</span><span class="m">2</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="m">2</span><span class="p">)</span><span class="n">]</span> <span class="o">&lt;-</span> <span class="n">y2</span>
</span></span><span class="line"><span class="cl"><span class="n">id</span> <span class="o">&lt;-</span> <span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">n</span><span class="p">,</span> <span class="n">each</span> <span class="o">=</span> <span class="m">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create design matrix</span>
</span></span><span class="line"><span class="cl"><span class="n">X</span> <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="m">1</span><span class="p">,</span> <span class="n">nrow</span> <span class="o">=</span> <span class="n">n</span><span class="o">*</span><span class="m">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Change first column</span>
</span></span><span class="line"><span class="cl"><span class="n">X[</span><span class="p">,</span> <span class="m">1</span><span class="n">]</span> <span class="o">&lt;-</span> <span class="nf">rep</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">-1</span><span class="p">),</span> <span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Loop through X</span>
</span></span><span class="line"><span class="cl"><span class="nf">for</span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="m">1</span><span class="o">:</span><span class="n">n</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="n">X</span><span class="nf">[which</span><span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">i</span><span class="p">),</span> <span class="n">i</span> <span class="o">+</span> <span class="m">1</span><span class="n">]</span> <span class="o">&lt;-</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Display design matrix</span>
</span></span><span class="line"><span class="cl"><span class="nf">dispDesignMatrix</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">title</span><span class="p">(</span><span class="n">main</span> <span class="o">=</span> <span class="s">&#39;Paired t-test design matrix&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/post/2023-02-14-understanding-the-basics-of-the-general-linear-model-glm-in-the-context-of-fmri/figure-gfm/paired_t_test1-1.png" alt=""><!-- --></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># Estimate betas</span>
</span></span><span class="line"><span class="cl"><span class="n">B</span> <span class="o">&lt;-</span> <span class="nf">solve</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">%*%</span> <span class="n">X</span><span class="p">)</span> <span class="o">%*%</span> <span class="nf">t</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">Y</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Calculate residual variance</span>
</span></span><span class="line"><span class="cl"><span class="n">Y_hat</span> <span class="o">&lt;-</span> <span class="n">X</span> <span class="o">%*%</span> <span class="n">B</span>
</span></span><span class="line"><span class="cl"><span class="n">E</span> <span class="o">&lt;-</span> <span class="n">Y</span> <span class="o">-</span> <span class="n">Y_hat</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">&lt;-</span> <span class="nf">ncol</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">N</span> <span class="o">&lt;-</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">resid_var</span> <span class="o">&lt;-</span> <span class="nf">as.numeric</span><span class="p">((</span><span class="nf">t</span><span class="p">(</span><span class="n">E</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">E</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="n">p</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Contrast</span>
</span></span><span class="line"><span class="cl"><span class="n">con</span> <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="nf">rep</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)),</span> <span class="n">ncol</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Calculate the t value</span>
</span></span><span class="line"><span class="cl"><span class="n">numerator</span>   <span class="o">&lt;-</span> <span class="n">con</span> <span class="o">%*%</span> <span class="n">B</span>
</span></span><span class="line"><span class="cl"><span class="n">denominator</span> <span class="o">&lt;-</span> <span class="nf">sqrt</span><span class="p">(</span><span class="n">con</span> <span class="o">%*%</span> <span class="nf">solve</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">%*%</span> <span class="n">X</span><span class="p">)</span> <span class="o">%*%</span> <span class="nf">t</span><span class="p">(</span><span class="n">con</span><span class="p">)</span> <span class="o">*</span> <span class="n">resid_var</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">t_value</span>     <span class="o">&lt;-</span> <span class="n">numerator</span><span class="o">/</span><span class="n">denominator</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here the contrast has to be</p>
<p>$$ con = \begin{bmatrix} 1 &amp; 0 &amp; 0 &amp; 0 &amp; \cdots &amp; 0\end{bmatrix}$$ in
order to test $H_0: \beta_{diff} = 0$. As calculated with <code>t.test()</code>,
the $t$-value is 0.2388.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="nf">t.test</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">paired</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>## 
##  Paired t-test
## 
## data:  y1 and y2
## t = 0.2388, df = 19, p-value = 0.8138
## alternative hypothesis: true difference in means is not equal to 0
## 95 percent confidence interval:
##  -0.6600471  0.8300599
## sample estimates:
## mean of the differences 
##              0.08500641
</code></pre>
<h2 id="two-way-anova">Two-way ANOVA</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># Fake data</span>
</span></span><span class="line"><span class="cl"><span class="n">n</span>  <span class="o">&lt;-</span> <span class="m">20</span>
</span></span><span class="line"><span class="cl"><span class="n">A1B1</span> <span class="o">&lt;-</span> <span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">A1B2</span> <span class="o">&lt;-</span> <span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="m">0.2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">A1B3</span> <span class="o">&lt;-</span> <span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="m">-0.3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">A2B1</span> <span class="o">&lt;-</span> <span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="m">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">A2B2</span> <span class="o">&lt;-</span> <span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="m">-1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">A2B3</span> <span class="o">&lt;-</span> <span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="m">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Y</span>    <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="n">A1B1</span><span class="p">,</span> <span class="n">A1B2</span><span class="p">,</span> <span class="n">A1B3</span><span class="p">,</span> <span class="n">A2B1</span><span class="p">,</span> <span class="n">A2B2</span><span class="p">,</span> <span class="n">A2B3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">A_factor</span>  <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="s">&#34;A1&#34;</span><span class="p">,</span> <span class="n">n</span><span class="o">*</span><span class="m">3</span><span class="p">),</span> <span class="nf">rep</span><span class="p">(</span><span class="s">&#34;A2&#34;</span><span class="p">,</span> <span class="n">n</span><span class="o">*</span><span class="m">3</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">B_factor</span>  <span class="o">&lt;-</span> <span class="nf">rep</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="s">&#34;B1&#34;</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="nf">rep</span><span class="p">(</span><span class="s">&#34;B2&#34;</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="nf">rep</span><span class="p">(</span><span class="s">&#34;B3&#34;</span><span class="p">,</span> <span class="n">n</span><span class="p">)),</span> <span class="m">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span>        <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span><span class="p">,</span> <span class="n">A_factor</span> <span class="o">=</span> <span class="n">A_factor</span><span class="p">,</span> <span class="n">B_factor</span> <span class="o">=</span> <span class="n">B_factor</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create design matrix</span>
</span></span><span class="line"><span class="cl"><span class="n">params</span> <span class="o">&lt;-</span> <span class="m">2</span> <span class="o">*</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">X</span> <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="n">params</span><span class="p">,</span> <span class="n">nrow</span> <span class="o">=</span> <span class="n">n</span><span class="o">*</span><span class="n">params</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Change first row to be the beta mean</span>
</span></span><span class="line"><span class="cl"><span class="n">X[</span><span class="p">,</span> <span class="m">1</span><span class="n">]</span> <span class="o">&lt;-</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Change the second row to be betaA1</span>
</span></span><span class="line"><span class="cl"><span class="n">X[</span><span class="p">,</span> <span class="m">2</span><span class="n">]</span> <span class="o">&lt;-</span> <span class="nf">rep</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">-1</span><span class="p">),</span> <span class="n">each</span> <span class="o">=</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">/</span><span class="m">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Change the third row to be betaB1</span>
</span></span><span class="line"><span class="cl"><span class="n">X[</span><span class="p">,</span> <span class="m">3</span><span class="n">]</span> <span class="o">&lt;-</span> <span class="nf">rep</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">-1</span><span class="p">),</span> <span class="n">each</span> <span class="o">=</span> <span class="n">n</span><span class="p">),</span> <span class="m">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Change the fourth row to be betaB2</span>
</span></span><span class="line"><span class="cl"><span class="n">X[</span><span class="p">,</span> <span class="m">4</span><span class="n">]</span> <span class="o">&lt;-</span> <span class="nf">rep</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">-1</span><span class="p">),</span> <span class="n">each</span> <span class="o">=</span> <span class="n">n</span><span class="p">),</span> <span class="m">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Change the fifth row to be betaA1B1</span>
</span></span><span class="line"><span class="cl"><span class="n">X[</span><span class="p">,</span> <span class="m">5</span><span class="n">]</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">-1</span><span class="p">),</span> <span class="n">each</span> <span class="o">=</span> <span class="n">n</span><span class="p">),</span> <span class="nf">rep</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">-1</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> <span class="n">each</span> <span class="o">=</span> <span class="n">n</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Change the sixth row to be betaA1B2</span>
</span></span><span class="line"><span class="cl"><span class="n">X[</span><span class="p">,</span> <span class="m">6</span><span class="n">]</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">-1</span><span class="p">),</span> <span class="n">each</span> <span class="o">=</span> <span class="n">n</span><span class="p">),</span> <span class="nf">rep</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">-1</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> <span class="n">each</span> <span class="o">=</span> <span class="n">n</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Display design matrix</span>
</span></span><span class="line"><span class="cl"><span class="nf">dispDesignMatrix</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">title</span><span class="p">(</span><span class="n">main</span> <span class="o">=</span> <span class="s">&#39;2 x 2 Anova design matrix&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/post/2023-02-14-understanding-the-basics-of-the-general-linear-model-glm-in-the-context-of-fmri/figure-gfm/two_way_anova-1.png" alt=""><!-- --></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># Estimate betas</span>
</span></span><span class="line"><span class="cl"><span class="n">B</span> <span class="o">&lt;-</span> <span class="nf">solve</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">%*%</span> <span class="n">X</span><span class="p">)</span> <span class="o">%*%</span> <span class="nf">t</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">Y</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Calculate residual variance</span>
</span></span><span class="line"><span class="cl"><span class="n">Y_hat</span> <span class="o">&lt;-</span> <span class="n">X</span> <span class="o">%*%</span> <span class="n">B</span>
</span></span><span class="line"><span class="cl"><span class="n">E</span> <span class="o">&lt;-</span> <span class="n">Y</span> <span class="o">-</span> <span class="n">Y_hat</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">&lt;-</span> <span class="nf">ncol</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">N</span> <span class="o">&lt;-</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">resid_var</span> <span class="o">&lt;-</span> <span class="nf">as.numeric</span><span class="p">((</span><span class="nf">t</span><span class="p">(</span><span class="n">E</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">E</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="n">p</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Covariance of beta</span>
</span></span><span class="line"><span class="cl"><span class="n">Cov_hat_beta</span> <span class="o">&lt;-</span> <span class="nf">solve</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="n">resid_var</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Contrasts &amp; tests</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Con 1: Overall mean </span>
</span></span><span class="line"><span class="cl"><span class="n">con1</span>    <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span> <span class="p">,</span><span class="m">0</span> <span class="p">,</span><span class="m">0</span><span class="p">),</span> <span class="n">nrow</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span>       <span class="o">&lt;-</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="nf">rankMatrix</span><span class="p">(</span><span class="n">con1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">F_stat1</span> <span class="o">&lt;-</span> <span class="nf">t</span><span class="p">(</span><span class="n">con1</span> <span class="o">%*%</span> <span class="n">B</span><span class="p">)</span> <span class="o">%*%</span> <span class="nf">solve</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">con1</span> <span class="o">%*%</span> <span class="n">Cov_hat_beta</span> <span class="o">%*%</span> <span class="nf">t</span><span class="p">(</span><span class="n">con1</span><span class="p">))</span> <span class="o">%*%</span> <span class="p">(</span><span class="n">con1</span> <span class="o">%*%</span> <span class="n">B</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Con 2: Main A effect</span>
</span></span><span class="line"><span class="cl"><span class="n">con2</span>    <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span> <span class="p">,</span><span class="m">0</span> <span class="p">,</span><span class="m">0</span><span class="p">),</span> <span class="n">nrow</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span>       <span class="o">&lt;-</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="nf">rankMatrix</span><span class="p">(</span><span class="n">con2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">F_stat2</span> <span class="o">&lt;-</span> <span class="nf">t</span><span class="p">(</span><span class="n">con2</span> <span class="o">%*%</span> <span class="n">B</span><span class="p">)</span> <span class="o">%*%</span> <span class="nf">solve</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">con2</span> <span class="o">%*%</span> <span class="n">Cov_hat_beta</span> <span class="o">%*%</span> <span class="nf">t</span><span class="p">(</span><span class="n">con2</span><span class="p">))</span> <span class="o">%*%</span> <span class="p">(</span><span class="n">con2</span> <span class="o">%*%</span> <span class="n">B</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Con 3: Main B effect</span>
</span></span><span class="line"><span class="cl"><span class="n">con3</span>    <span class="o">&lt;-</span> <span class="nf">rbind</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">0</span> <span class="p">,</span><span class="m">0</span> <span class="p">,</span><span class="m">0</span><span class="p">),</span> <span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span>       <span class="o">&lt;-</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="nf">rankMatrix</span><span class="p">(</span><span class="n">con3</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">F_stat3</span> <span class="o">&lt;-</span> <span class="nf">t</span><span class="p">(</span><span class="n">con3</span> <span class="o">%*%</span> <span class="n">B</span><span class="p">)</span> <span class="o">%*%</span> <span class="nf">solve</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">con3</span> <span class="o">%*%</span> <span class="n">Cov_hat_beta</span> <span class="o">%*%</span> <span class="nf">t</span><span class="p">(</span><span class="n">con3</span><span class="p">))</span> <span class="o">%*%</span> <span class="p">(</span><span class="n">con3</span> <span class="o">%*%</span> <span class="n">B</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Con 4: A/B interaction effect</span>
</span></span><span class="line"><span class="cl"><span class="n">con4</span>    <span class="o">&lt;-</span> <span class="nf">rbind</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span> <span class="p">,</span><span class="m">1</span> <span class="p">,</span><span class="m">0</span><span class="p">),</span> <span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span>       <span class="o">&lt;-</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="nf">rankMatrix</span><span class="p">(</span><span class="n">con4</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">F_stat4</span> <span class="o">&lt;-</span> <span class="nf">t</span><span class="p">(</span><span class="n">con4</span> <span class="o">%*%</span> <span class="n">B</span><span class="p">)</span> <span class="o">%*%</span> <span class="nf">solve</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">con4</span> <span class="o">%*%</span> <span class="n">Cov_hat_beta</span> <span class="o">%*%</span> <span class="nf">t</span><span class="p">(</span><span class="n">con4</span><span class="p">))</span> <span class="o">%*%</span> <span class="p">(</span><span class="n">con4</span> <span class="o">%*%</span> <span class="n">B</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Con 5: Overall effect (any group difference)?</span>
</span></span><span class="line"><span class="cl"><span class="n">con5</span>    <span class="o">&lt;-</span> <span class="nf">diag</span><span class="p">(</span><span class="m">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">con5</span>    <span class="o">&lt;-</span> <span class="n">con5[</span><span class="m">-1</span><span class="p">,</span><span class="n">]</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span>       <span class="o">&lt;-</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="nf">rankMatrix</span><span class="p">(</span><span class="n">con5</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">F_stat5</span> <span class="o">&lt;-</span> <span class="nf">t</span><span class="p">(</span><span class="n">con5</span> <span class="o">%*%</span> <span class="n">B</span><span class="p">)</span> <span class="o">%*%</span> <span class="nf">solve</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">con5</span> <span class="o">%*%</span> <span class="n">Cov_hat_beta</span> <span class="o">%*%</span> <span class="nf">t</span><span class="p">(</span><span class="n">con5</span><span class="p">))</span> <span class="o">%*%</span> <span class="p">(</span><span class="n">con5</span> <span class="o">%*%</span> <span class="n">B</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Again, we can compare this to what base R functions estimate:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">res.aov</span> <span class="o">&lt;-</span> <span class="nf">aov</span><span class="p">(</span><span class="n">Y</span> <span class="o">~</span> <span class="n">A_factor</span>  <span class="o">*</span> <span class="n">B_factor</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">df</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">summary</span><span class="p">(</span><span class="n">res.aov</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>##                    Df Sum Sq Mean Sq F value Pr(&gt;F)    
## A_factor            1  188.2  188.22  175.42 &lt;2e-16 ***
## B_factor            2  161.5   80.77   75.27 &lt;2e-16 ***
## A_factor:B_factor   2  220.7  110.37  102.86 &lt;2e-16 ***
## Residuals         114  122.3    1.07                   
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
</code></pre>
<p>which fits with our $F$-values that we estimated 175.4229, 75.2738,
102.8615.</p>
<h1 id="does-the-contrast-weighting-matter-for-the-test-statistics">Does the contrast weighting matter for the test-statistics?</h1>
<p>One thing I asked myself when thinking about it, is whether matters and if not
why doesn’t it matter how we have weigh our contrast. Often we read that
the contrast $con_1$ gives use the average of the two betas but is this true? Let’s look
at this for two-sample $t$-test.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># Generate new data</span>
</span></span><span class="line"><span class="cl"><span class="n">y1</span> <span class="o">&lt;-</span> <span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">y2</span> <span class="o">&lt;-</span> <span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="m">0.3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Y</span>  <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create design matrix</span>
</span></span><span class="line"><span class="cl"><span class="n">X</span> <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">0</span><span class="p">),</span> <span class="n">each</span> <span class="o">=</span> <span class="n">n</span><span class="p">),</span> <span class="nf">rep</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">),</span> <span class="n">each</span> <span class="o">=</span> <span class="n">n</span><span class="p">)),</span> <span class="n">ncol</span> <span class="o">=</span> <span class="m">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Estimate betas</span>
</span></span><span class="line"><span class="cl"><span class="n">B</span> <span class="o">&lt;-</span> <span class="nf">solve</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">%*%</span> <span class="n">X</span><span class="p">)</span> <span class="o">%*%</span> <span class="nf">t</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">Y</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Calculate residual variance</span>
</span></span><span class="line"><span class="cl"><span class="n">Y_hat</span> <span class="o">&lt;-</span> <span class="n">X</span> <span class="o">%*%</span> <span class="n">B</span>
</span></span><span class="line"><span class="cl"><span class="n">E</span> <span class="o">&lt;-</span> <span class="n">Y</span> <span class="o">-</span> <span class="n">Y_hat</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">&lt;-</span> <span class="nf">ncol</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">N</span> <span class="o">&lt;-</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">resid_var</span> <span class="o">&lt;-</span> <span class="nf">as.numeric</span><span class="p">((</span><span class="nf">t</span><span class="p">(</span><span class="n">E</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">E</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="n">p</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Contrast</span>
</span></span><span class="line"><span class="cl"><span class="n">con1</span> <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> <span class="n">ncol</span> <span class="o">=</span> <span class="m">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">con2</span> <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">0.5</span><span class="p">,</span> <span class="m">0.5</span><span class="p">),</span> <span class="n">ncol</span> <span class="o">=</span> <span class="m">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Case 1</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Calculate the t value</span>
</span></span><span class="line"><span class="cl"><span class="n">numerator1</span>   <span class="o">&lt;-</span> <span class="n">con1</span> <span class="o">%*%</span> <span class="n">B</span>
</span></span><span class="line"><span class="cl"><span class="n">denominator1</span> <span class="o">&lt;-</span> <span class="nf">sqrt</span><span class="p">(</span><span class="n">con1</span> <span class="o">%*%</span> <span class="nf">solve</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">%*%</span> <span class="n">X</span><span class="p">)</span> <span class="o">%*%</span> <span class="nf">t</span><span class="p">(</span><span class="n">con1</span><span class="p">)</span> <span class="o">*</span> <span class="n">resid_var</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">t_value1</span>     <span class="o">&lt;-</span> <span class="n">numerator1</span><span class="o">/</span><span class="n">denominator1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Case 2</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Calculate the t value</span>
</span></span><span class="line"><span class="cl"><span class="n">numerator2</span>   <span class="o">&lt;-</span> <span class="n">con2</span> <span class="o">%*%</span> <span class="n">B</span>
</span></span><span class="line"><span class="cl"><span class="n">denominator2</span> <span class="o">&lt;-</span> <span class="nf">sqrt</span><span class="p">(</span><span class="n">con2</span> <span class="o">%*%</span> <span class="nf">solve</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">%*%</span> <span class="n">X</span><span class="p">)</span> <span class="o">%*%</span> <span class="nf">t</span><span class="p">(</span><span class="n">con2</span><span class="p">)</span> <span class="o">*</span> <span class="n">resid_var</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">t_value2</span>     <span class="o">&lt;-</span> <span class="n">numerator2</span><span class="o">/</span><span class="n">denominator2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>when we look at the numerator for $con_1$, which is supposed to
represent the average of both $\beta$s we see that it is 0.164 but the
average of $Y$ is only 0.082. So, in fact we get the average of the
$\beta$s/groups times 2! We only actually get the <em>true</em> average when we use $con_2$ as a contrast, here the numerator is indeed 0.082. Does this actually matter for the test statistic? Well, no because as we scale the
numerator by two, we also scale the denominator by the same amount and it
cancels each other out. Both contrasts get exactly the same $t$-value of
0.565176.</p>
<h1 id="covariance-matrix-of-the-residuals">Covariance matrix of the residuals</h1>
<p>So, while reading through the Poldrack’s book I kind of stumbled over the
concept of the covariance matrix of the residuals, which this is an
important concept for time-series and heterogeneous variances but I
didn’t really understand it when I am honest. So here I am trying to
explore this:</p>
<p>The variance-covariance matrix is given by (in Kutner, 2005 this is
written as $\sigma^2{\epsilon}$ and $MSE$ is used for estimation)</p>
<p>$$ \hat{Cov}(\hat{\epsilon}) = \sigma^2(I-H) $$</p>
<p>where $I$ is the identity matrix and $H$ is the so-called hat matrix
that essentially can be used to transform $Y$ into $\hat{Y}$ directly
(i.e. $\hat{Y} = HY$).</p>
<p>$$ H = X(X^\intercal X)^{-1}X^\intercal$$</p>
<p>Let’s calculate the covariance-variance matrix for our last example (the
2 x 2 ANOVA)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">H</span>         <span class="o">&lt;-</span> <span class="n">X</span> <span class="o">%*%</span> <span class="nf">solve</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">X</span><span class="p">)</span> <span class="o">%*%</span> <span class="nf">t</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">I</span>         <span class="o">&lt;-</span> <span class="nf">diag</span><span class="p">(</span><span class="nf">nrow</span><span class="p">(</span><span class="n">H</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">resid_cov</span> <span class="o">&lt;-</span> <span class="n">resid_var</span> <span class="o">*</span> <span class="p">(</span><span class="n">I</span> <span class="o">-</span> <span class="n">H</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Display design matrix</span>
</span></span><span class="line"><span class="cl"><span class="nf">dispDesignMatrix</span><span class="p">(</span><span class="n">resid_cov</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">title</span><span class="p">(</span><span class="n">main</span> <span class="o">=</span> <span class="s">&#39;Variance-covariance matrix for the 2 x 2 ANOVA example&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/post/2023-02-14-understanding-the-basics-of-the-general-linear-model-glm-in-the-context-of-fmri/figure-gfm/calculate_hat_matrix-1.png" alt=""><!-- --></p>
<p>as when using the formula we can see $\hat{Cov}(\hat{\epsilon})$ is
indeed a matrix with values close to zero off the diagonals and the a
constant value on the diagonals. <strong>Important note</strong>: this estimation is
only based on the design matrix $X$ so it doesn’t represent a feature of
the data because we can’t really estimate the covariance of the true
residuals so calculating this for your model will tell you nothing. It
is simply an important assumption that is made about the data in order
for everything to check out as intended. I found
<a href="https://stats.stackexchange.com/questions/467779/covariance-matrix-of-the-residuals-in-the-linear-regression-model">this</a>
helpful post about it.</p>
<h1 id="a-example-design-matrix-for-fmri">A example design matrix for fMRI</h1>
<p>The last thing directly related to the GLM that I wanted to explore is
what first-level fMRI GLMs typically look like. That is because the
actual design matrix used when fitting a GLM to fMRI data are the
regressors (i.e. time points) convolved with the
<a href="https://en.wikipedia.org/wiki/Haemodynamic_response">HRF</a>. This is
based on explanations and code from Jeanette Mumford
(<a href="https://www.youtube.com/watch?v=H1S72z6o3HY">video</a> &amp;
<a href="https://www.dropbox.com/s/j8t2be1604fnmnv/collinearity_illustration.R?dl=0">code</a>).
Here I illustrate constructing regressors for an first-level fMRI
analysis. Note that in principle you want to convolve your events
(onset + duration) with the HRF at a higher temporal resolution but for
what ever reason this doesn’t seem to work well with the package that I
am using. (Update: This is soon to be fixed by the developers.)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># Libs</span>
</span></span><span class="line"><span class="cl"><span class="nf">library</span><span class="p">(</span><span class="n">fmri</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Input parameters</span>
</span></span><span class="line"><span class="cl"><span class="n">TR_conv</span>    <span class="o">&lt;-</span> <span class="m">1</span> 
</span></span><span class="line"><span class="cl"><span class="n">numOfScans</span> <span class="o">&lt;-</span> <span class="m">100</span>
</span></span><span class="line"><span class="cl"><span class="n">numEvents1</span> <span class="o">&lt;-</span> <span class="m">20</span>
</span></span><span class="line"><span class="cl"><span class="n">numEvents2</span> <span class="o">&lt;-</span> <span class="m">20</span>
</span></span><span class="line"><span class="cl"><span class="n">duration1</span>  <span class="o">&lt;-</span> <span class="m">2</span><span class="o">/</span><span class="n">TR_conv</span>   <span class="c1"># in scans</span>
</span></span><span class="line"><span class="cl"><span class="n">duration2</span>  <span class="o">&lt;-</span> <span class="m">1.5</span><span class="o">/</span><span class="n">TR_conv</span> <span class="c1"># in scans</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1"># Calculated parameters based on input</span>
</span></span><span class="line"><span class="cl"><span class="n">onsets1</span>   <span class="o">&lt;-</span> <span class="nf">sample</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">numOfScans</span><span class="p">,</span> <span class="n">numEvents1</span><span class="p">)</span> <span class="c1"># Onset in scans</span>
</span></span><span class="line"><span class="cl"><span class="n">onsets2</span>   <span class="o">&lt;-</span> <span class="nf">sample</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">numOfScans</span><span class="p">,</span> <span class="n">numEvents2</span><span class="p">)</span> <span class="c1"># Onset in scans</span>
</span></span><span class="line"><span class="cl"><span class="n">duration1</span> <span class="o">&lt;-</span> <span class="nf">rep</span><span class="p">(</span><span class="n">duration1</span><span class="p">,</span> <span class="nf">length</span><span class="p">(</span><span class="n">onsets1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">duration2</span> <span class="o">&lt;-</span> <span class="nf">rep</span><span class="p">(</span><span class="n">duration2</span><span class="p">,</span> <span class="nf">length</span><span class="p">(</span><span class="n">onsets2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create regressors</span>
</span></span><span class="line"><span class="cl"><span class="n">regressor1</span> <span class="o">&lt;-</span> <span class="nf">fmri.stimulus</span><span class="p">(</span><span class="n">numOfScans</span><span class="p">,</span> <span class="n">onsets1</span><span class="p">,</span> <span class="n">duration1</span><span class="p">,</span> <span class="n">TR_conv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">regressor2</span> <span class="o">&lt;-</span> <span class="nf">fmri.stimulus</span><span class="p">(</span><span class="n">numOfScans</span><span class="p">,</span> <span class="n">onsets2</span><span class="p">,</span> <span class="n">duration2</span><span class="p">,</span> <span class="n">TR_conv</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The results can be visualised as</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># Visualiation libs</span>
</span></span><span class="line"><span class="cl"><span class="nf">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">library</span><span class="p">(</span><span class="n">cowplot</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create DFs</span>
</span></span><span class="line"><span class="cl"><span class="n">df1_events</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">onsets</span> <span class="o">=</span> <span class="n">onsets1</span><span class="p">,</span> <span class="n">duration</span> <span class="o">=</span> <span class="n">duration1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df2_events</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">onsets</span> <span class="o">=</span> <span class="n">onsets2</span><span class="p">,</span> <span class="n">duration</span> <span class="o">=</span> <span class="n">duration2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df1_BOLD</span>   <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">scans</span> <span class="o">=</span> <span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">regressor1</span><span class="p">),</span> <span class="n">Regressor</span> <span class="o">=</span> <span class="n">regressor1</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="n">df2_BOLD</span>   <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">scans</span> <span class="o">=</span> <span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">regressor2</span><span class="p">),</span> <span class="n">Regressor</span> <span class="o">=</span> <span class="n">regressor2</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Plots</span>
</span></span><span class="line"><span class="cl"><span class="n">stickPlot1</span> <span class="o">&lt;-</span> <span class="nf">ggplot</span><span class="p">(</span><span class="n">df1_events</span><span class="p">)</span> <span class="o">+</span> 
</span></span><span class="line"><span class="cl">  <span class="nf">geom_rect</span><span class="p">(</span><span class="n">mapping</span> <span class="o">=</span> <span class="nf">aes</span><span class="p">(</span><span class="n">xmin</span> <span class="o">=</span> <span class="n">onsets</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">onsets</span> <span class="o">+</span> <span class="n">duration</span><span class="p">,</span> <span class="n">ymin</span> <span class="o">=</span> <span class="m">0</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="m">1</span><span class="p">))</span> <span class="o">+</span> 
</span></span><span class="line"><span class="cl">  <span class="nf">theme</span><span class="p">(</span><span class="n">axis.ticks.y</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span> <span class="n">axis.text.y</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">())</span> <span class="o">+</span> 
</span></span><span class="line"><span class="cl">  <span class="nf">labs</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s">&#34;Scans&#34;</span><span class="p">)</span> <span class="o">+</span> 
</span></span><span class="line"><span class="cl">  <span class="nf">coord_cartesian</span><span class="p">(</span><span class="n">xlim</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="nf">length</span><span class="p">(</span><span class="n">regressor1</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">stickPlot2</span> <span class="o">&lt;-</span> <span class="nf">ggplot</span><span class="p">(</span><span class="n">df2_events</span><span class="p">)</span> <span class="o">+</span> 
</span></span><span class="line"><span class="cl">  <span class="nf">geom_rect</span><span class="p">(</span><span class="n">mapping</span> <span class="o">=</span> <span class="nf">aes</span><span class="p">(</span><span class="n">xmin</span> <span class="o">=</span> <span class="n">onsets</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">onsets</span> <span class="o">+</span> <span class="n">duration</span><span class="p">,</span> <span class="n">ymin</span> <span class="o">=</span> <span class="m">0</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="m">1</span><span class="p">))</span> <span class="o">+</span> 
</span></span><span class="line"><span class="cl">  <span class="nf">theme</span><span class="p">(</span><span class="n">axis.ticks.y</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span> <span class="n">axis.text.y</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">())</span> <span class="o">+</span> 
</span></span><span class="line"><span class="cl">  <span class="nf">labs</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s">&#34;Scans&#34;</span><span class="p">)</span> <span class="o">+</span> 
</span></span><span class="line"><span class="cl">  <span class="nf">coord_cartesian</span><span class="p">(</span><span class="n">xlim</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="nf">length</span><span class="p">(</span><span class="n">regressor2</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">BOLD_plot1</span> <span class="o">&lt;-</span> <span class="nf">ggplot</span><span class="p">(</span><span class="n">df1_BOLD</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">scans</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">Regressor</span><span class="p">))</span> <span class="o">+</span> <span class="nf">geom_line</span><span class="p">()</span> <span class="o">+</span> <span class="nf">labs</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="p">)</span> <span class="o">+</span> 
</span></span><span class="line"><span class="cl">  <span class="nf">coord_cartesian</span><span class="p">(</span><span class="n">xlim</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="nf">length</span><span class="p">(</span><span class="n">regressor1</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">BOLD_plot2</span> <span class="o">&lt;-</span> <span class="nf">ggplot</span><span class="p">(</span><span class="n">df2_BOLD</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">scans</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">Regressor</span><span class="p">))</span> <span class="o">+</span> <span class="nf">geom_line</span><span class="p">()</span> <span class="o">+</span> <span class="nf">labs</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="p">)</span> <span class="o">+</span> 
</span></span><span class="line"><span class="cl">  <span class="nf">coord_cartesian</span><span class="p">(</span><span class="n">xlim</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="nf">length</span><span class="p">(</span><span class="n">regressor2</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Combination</span>
</span></span><span class="line"><span class="cl"><span class="nf">plot_grid</span><span class="p">(</span><span class="n">BOLD_plot1</span><span class="p">,</span> <span class="n">BOLD_plot2</span><span class="p">,</span> <span class="n">stickPlot1</span><span class="p">,</span> <span class="n">stickPlot2</span><span class="p">,</span> <span class="n">align</span> <span class="o">=</span> <span class="s">&#34;v&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/post/2023-02-14-understanding-the-basics-of-the-general-linear-model-glm-in-the-context-of-fmri/figure-gfm/actual_fMRI_regressor_visualisation-1.png" alt=""><!-- --></p>
<p>The resulting design matrix as used for fMRI would look like this</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># Create design matrix</span>
</span></span><span class="line"><span class="cl"><span class="n">X</span> <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="nf">length</span><span class="p">(</span><span class="n">regressor1</span><span class="p">)),</span> <span class="n">regressor1</span><span class="p">,</span> <span class="n">regressor2</span><span class="p">),</span> <span class="n">ncol</span> <span class="o">=</span> <span class="m">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Display design matrix</span>
</span></span><span class="line"><span class="cl"><span class="nf">dispDesignMatrix</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">title</span><span class="p">(</span><span class="n">main</span> <span class="o">=</span> <span class="s">&#39;Design matrix based on convolutation with HRF&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/post/2023-02-14-understanding-the-basics-of-the-general-linear-model-glm-in-the-context-of-fmri/figure-gfm/actual_fMRI_design_matrix-1.png" alt=""><!-- --></p>
<p>This, in other words a simple multiple regression model with continuous
regressors, is what actually would be used to model the brain responses
(at least for the first level analysis). Again, this ignores the problem
of auto-correlation in the time-series and that the assumption about the
covariance variance matrix of the residuals would not hold without extra
steps, which are ignored here.</p>
<h1 id="multiple-testing-problem">Multiple testing problem</h1>
<p>The last problem I looked is not really GLM specific but important for
fMRI analyses. When doing mass-univariate statistics on the brain, this
usually means that we in fact run more than 100,000 individual tests as
at least one test is run per voxel in the brain image. This is
illustrated with this example of 2D fake brain image:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># Seed</span>
</span></span><span class="line"><span class="cl"><span class="nf">set.seed</span><span class="p">(</span><span class="m">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create smoothed image</span>
</span></span><span class="line"><span class="cl"><span class="n">numberOfVoxels</span>      <span class="o">&lt;-</span> <span class="m">316</span><span class="o">*</span><span class="m">316</span>
</span></span><span class="line"><span class="cl"><span class="n">brainImage</span>          <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="nf">rnorm</span><span class="p">(</span><span class="n">numberOfVoxels</span><span class="p">),</span> <span class="n">ncol</span> <span class="o">=</span> <span class="nf">sqrt</span><span class="p">(</span><span class="n">numberOfVoxels</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">brainImage_smoothed</span> <span class="o">&lt;-</span> <span class="nf">gaussianSmooth2D</span><span class="p">(</span><span class="n">brainImage</span><span class="p">,</span> <span class="n">kernelSize</span> <span class="o">=</span> <span class="m">3</span><span class="p">,</span> <span class="n">kernelSD</span> <span class="o">=</span> <span class="m">0.6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Significant values etc</span>
</span></span><span class="line"><span class="cl"><span class="n">cutoff</span>    <span class="o">&lt;-</span> <span class="nf">qnorm</span><span class="p">(</span><span class="m">0.05</span><span class="o">/</span><span class="m">2</span><span class="p">)</span> <span class="c1"># Cut off value for 95 % for two-tailed test</span>
</span></span><span class="line"><span class="cl"><span class="n">sig_num1</span>  <span class="o">&lt;-</span> <span class="nf">sum</span><span class="p">(</span><span class="n">brainImage</span> <span class="o">&lt;</span> <span class="n">cutoff</span> <span class="o">|</span> <span class="n">brainImage</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">cutoff</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sig_num2</span>  <span class="o">&lt;-</span> <span class="nf">sum</span><span class="p">(</span><span class="n">brainImage_smoothed</span> <span class="o">&lt;</span> <span class="n">cutoff</span> <span class="o">|</span> <span class="n">brainImage_smoothed</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">cutoff</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sig_rate1</span> <span class="o">&lt;-</span> <span class="nf">mean</span><span class="p">(</span><span class="n">brainImage</span> <span class="o">&lt;</span> <span class="n">cutoff</span> <span class="o">|</span> <span class="n">brainImage</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">cutoff</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sig_rate2</span> <span class="o">&lt;-</span> <span class="nf">mean</span><span class="p">(</span><span class="n">brainImage_smoothed</span> <span class="o">&lt;</span> <span class="n">cutoff</span> <span class="o">|</span> <span class="n">brainImage_smoothed</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">cutoff</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Threshold the image</span>
</span></span><span class="line"><span class="cl"><span class="n">brainImage_smoothed_threshold</span> <span class="o">&lt;-</span> <span class="n">brainImage_smoothed</span>
</span></span><span class="line"><span class="cl"><span class="n">brainImage_smoothed_threshold[brainImage_smoothed_threshold</span> <span class="o">&gt;</span> <span class="n">cutoff</span> <span class="o">&amp;</span> <span class="n">brainImage_smoothed_threshold</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">cutoff]</span> <span class="o">&lt;-</span> <span class="kc">NA</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Plot</span>
</span></span><span class="line"><span class="cl"><span class="nf">plot_grid</span><span class="p">(</span><span class="nf">levelplot</span><span class="p">(</span><span class="n">brainImage_smoothed</span><span class="p">),</span> <span class="nf">levelplot</span><span class="p">(</span><span class="n">brainImage_smoothed_threshold</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/post/2023-02-14-understanding-the-basics-of-the-general-linear-model-glm-in-the-context-of-fmri/figure-gfm/brain_image-1.png" alt=""><!-- --></p>
<p>Even if there is no true effect, there are quite a number of significant
voxels in that 2D brain image even when I smoothed it (13 voxel). In the
unsmoothed image, we get a number of significant cases that is pretty
much expected given the number of tests that we simulated (5060 voxels
or 5.07 %). In real fMRI the false positive rate is obviously not that
bad because voxels are not actually independent but it is still an
important issue.</p>
<p>Note I am only discussing voxel-wise corrections but many of the
concepts below also work for cluster level.</p>
<h2 id="calculate-fwe">Calculate FWE</h2>
<p>As defined below, FWE = chance of 1 more significant voxels in the brain
and we want that to be 5%. So how much is the FWE in my completely
fictional example for smoothed image.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># Simulation parameters</span>
</span></span><span class="line"><span class="cl"><span class="n">cutoff</span> <span class="o">&lt;-</span> <span class="nf">qnorm</span><span class="p">(</span><span class="m">0.05</span><span class="o">/</span><span class="m">2</span><span class="p">)</span> <span class="c1"># Cut off value for 95 % for two-tailed test</span>
</span></span><span class="line"><span class="cl"><span class="n">nSim</span>   <span class="o">&lt;-</span> <span class="m">10000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Function to calculate FWE and create max distribution (see below)</span>
</span></span><span class="line"><span class="cl"><span class="n">simFun</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">numberOfVoxels</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># Create random smooth image</span>
</span></span><span class="line"><span class="cl">  <span class="n">brainImage</span>          <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="nf">rnorm</span><span class="p">(</span><span class="n">numberOfVoxels</span><span class="p">),</span> <span class="n">ncol</span> <span class="o">=</span> <span class="nf">sqrt</span><span class="p">(</span><span class="n">numberOfVoxels</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="n">brainImage_smoothed</span> <span class="o">&lt;-</span> <span class="nf">gaussianSmooth2D</span><span class="p">(</span><span class="n">brainImage</span><span class="p">,</span> <span class="n">kernelSize</span> <span class="o">=</span> <span class="m">3</span><span class="p">,</span> <span class="n">kernelSD</span> <span class="o">=</span> <span class="m">0.6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1"># Calculate number of significant voxels</span>
</span></span><span class="line"><span class="cl">  <span class="n">sig_num</span>   <span class="o">&lt;-</span> <span class="nf">sum</span><span class="p">(</span><span class="n">brainImage_smoothed</span> <span class="o">&lt;</span> <span class="n">cutoff</span> <span class="o">|</span> <span class="n">brainImage_smoothed</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">cutoff</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">max_value</span> <span class="o">&lt;-</span> <span class="nf">max</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">brainImage_smoothed</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="nf">return</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">sig_num</span><span class="p">,</span> <span class="n">max_value</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Save results in here</span>
</span></span><span class="line"><span class="cl"><span class="n">sim_results</span> <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span><span class="kc">NA</span><span class="p">),</span> <span class="n">each</span> <span class="o">=</span> <span class="n">nSim</span><span class="p">),</span> <span class="n">ncol</span> <span class="o">=</span> <span class="m">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Loop for simulation</span>
</span></span><span class="line"><span class="cl"><span class="nf">for</span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="m">1</span><span class="o">:</span><span class="n">nSim</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="n">sim_results[i</span><span class="p">,</span> <span class="n">]</span> <span class="o">&lt;-</span> <span class="nf">simFun</span><span class="p">(</span><span class="n">numberOfVoxels</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Even with this relatively low number of significant voxels in each
smoothed image the FWE is very high with 99.9 %.</p>
<h2 id="fwe-correction">FWE correction</h2>
<p>As noted elsewhere Bonferroni is far too conservative. Two alternatives
to correct for the FWE rates are random field theory (RFT) &amp; permutation
testing.</p>
<h3 id="random-field-theory">Random field theory</h3>
<p>Famously, RFT is quite complex so I am not trying to dive much deeper
into this matter other than repeating an equation taken out of Poldrack
et al. (2011):</p>
<p>$$p_{FWE}^{vox} \approx R \times  \frac{(4ln(2))^{3/2}}{(2\pi)^2}e^{-t^2/2}(t^2-1)$$</p>
<p>where $R = V/(FWHM_xFWHM_yFWHM_z)$ (RESolution ELement aka RESEL) and
$V$ is the search volume.</p>
<h3 id="permutation-tests">Permutation tests</h3>
<p>Permutation tests are something that can be relatively easily be
simulated. This can be done by creating a number of brain images and
saving the max-value test statistic in this image. I already did this
while calculating the FWE above.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="nf">ggplot</span><span class="p">(</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="n">sim_results[</span><span class="p">,</span> <span class="m">2</span><span class="n">]</span><span class="p">),</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">z</span><span class="p">))</span> <span class="o">+</span> 
</span></span><span class="line"><span class="cl">  <span class="nf">geom_histogram</span><span class="p">(</span><span class="n">bins</span> <span class="o">=</span> <span class="m">100</span><span class="p">)</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">  <span class="nf">labs</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s">&#34;Z-value&#34;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s">&#34;Count&#34;</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s">&#34;Distribution of maximal absolute Z value&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/post/2023-02-14-understanding-the-basics-of-the-general-linear-model-glm-in-the-context-of-fmri/figure-gfm/max_distribtion-1.png" alt=""><!-- --></p>
<p>The FWE-corrected $p$-value is simply the percentage of values that are
larger than our test statistic in that distribution. Take for example a
z-value of 2.2025748. The $p$-values are as follows:</p>
<ul>
<li>Uncorrected: 0.0276247</li>
<li>Bonferroni corrected: 1 (the $\alpha$-level would be 5.0072104^{-7}).
In other words, we would only count absolute z-values of 5.0260363 or
higher as significant.</li>
<li>Permutation corrected: 0.3366. Here we would count values of at least
2.5175497 as significant.</li>
</ul>
<h2 id="fdr">FDR</h2>
<p>Another way to correct the p-value is using FDR for instance using
<a href="https://www.statology.org/benjamini-hochberg-procedure/">Benjamini’s &amp; Hochberg’s
proecdure</a>. To
simulate this, we again take our fake 2D brain image and convert the
z-values into p-values.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">zMap</span> <span class="o">&lt;-</span> <span class="n">brainImage_smoothed</span>
</span></span><span class="line"><span class="cl"><span class="n">pMap</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="m">1</span><span class="o">-</span><span class="nf">pnorm</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">zMap</span><span class="p">)))</span><span class="o">*</span><span class="m">2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As a reminder, we have 13 voxels that are deemed significant. In <em>Step
1</em> we have to sort our p-values from smallest to largest and assign a
rank.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">FDR_df</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="nf">sort</span><span class="p">(</span><span class="n">pMap</span><span class="p">),</span> <span class="n">rank</span> <span class="o">=</span> <span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">pMap</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>for <em>Step 2</em> we calculate the critical value for each p-value using</p>
<p>$$ crit =    (i/m)\times Q $$</p>
<ul>
<li>$i$ = rank of p-value</li>
<li>$m$ = total number of tests</li>
<li>$Q$ = your chosen false discovery rate, which we set to 0.05.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># Parameters for critical value calculation</span>
</span></span><span class="line"><span class="cl"><span class="n">m</span> <span class="o">&lt;-</span> <span class="n">numberOfVoxels</span>
</span></span><span class="line"><span class="cl"><span class="n">Q</span> <span class="o">&lt;-</span> <span class="m">0.05</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Calculation itself</span>
</span></span><span class="line"><span class="cl"><span class="n">FDR_df</span><span class="o">$</span><span class="n">crit</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="n">FDR_df</span><span class="o">$</span><span class="n">rank</span><span class="o">/</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">Q</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>Step 3</em> we try to find row where the value of the p-value is lower than
the critical value.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">FDR_df</span><span class="o">$</span><span class="n">lower</span> <span class="o">&lt;-</span> <span class="n">FDR_df</span><span class="o">$</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">FDR_df</span><span class="o">$</span><span class="n">crit</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In this case, <code>any(FDR_df$lower)</code> is FALSE. Finally for adjusting a
p-value according to this procedure we can use
<a href="https://stats.stackexchange.com/questions/238458/whats-the-formula-for-the-benjamini-hochberg-adjusted-p-value">this</a>
formula that I found:</p>
<center>
<p><img src="/post/2023-02-14-understanding-the-basics-of-the-general-linear-model-glm-in-the-context-of-fmri/figure-gfm/BH_adjustment_equation.PNG" alt="p^\mathrm{BH}{(i)} = \min\Big\{\min{j\gei}\big\{\frac{mp_{(j)}}{j}\big\},1\Big}"><!-- --></p>
</center>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">FDR_df</span><span class="o">$</span><span class="n">adjusted</span> <span class="o">&lt;-</span> <span class="nf">ifelse</span><span class="p">((</span><span class="n">FDR_df</span><span class="o">$</span><span class="n">p</span><span class="o">*</span><span class="n">m</span><span class="p">)</span><span class="o">/</span><span class="n">FDR_df</span><span class="o">$</span><span class="n">rank</span> <span class="o">&gt;</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="p">(</span><span class="n">FDR_df</span><span class="o">$</span><span class="n">p</span><span class="o">*</span><span class="n">m</span><span class="p">)</span><span class="o">/</span><span class="n">FDR_df</span><span class="o">$</span><span class="n">rank</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Then check if completely decreasing</span>
</span></span><span class="line"><span class="cl"><span class="nf">for</span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">FDR_df</span><span class="p">)</span><span class="o">:</span><span class="m">2</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="nf">if</span><span class="p">(</span><span class="n">FDR_df</span><span class="o">$</span><span class="n">adjusted[i]</span> <span class="o">&lt;</span> <span class="n">FDR_df</span><span class="o">$</span><span class="n">adjusted[i</span> <span class="o">-</span> <span class="m">1</span><span class="n">]</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">FDR_df</span><span class="o">$</span><span class="n">adjusted[i</span> <span class="o">-</span> <span class="m">1</span><span class="n">]</span> <span class="o">&lt;-</span> <span class="n">FDR_df</span><span class="o">$</span><span class="n">adjusted[i]</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This adjustment makes all our p-values 1. In more interesting example,
we get this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">ps</span>     <span class="o">&lt;-</span> <span class="nf">runif</span><span class="p">(</span><span class="m">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ps</span>     <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="m">0.001</span><span class="p">,</span> <span class="n">ps</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">FDR_df</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="nf">sort</span><span class="p">(</span><span class="n">ps</span><span class="p">),</span> <span class="n">rank</span> <span class="o">=</span> <span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">ps</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">m</span> <span class="o">&lt;-</span> <span class="nf">length</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Q</span> <span class="o">&lt;-</span> <span class="m">0.05</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Calculation itself</span>
</span></span><span class="line"><span class="cl"><span class="n">FDR_df</span><span class="o">$</span><span class="n">crit</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="n">FDR_df</span><span class="o">$</span><span class="n">rank</span><span class="o">/</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">Q</span>
</span></span><span class="line"><span class="cl"><span class="n">FDR_df</span><span class="o">$</span><span class="n">lower</span> <span class="o">&lt;-</span> <span class="n">FDR_df</span><span class="o">$</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">FDR_df</span><span class="o">$</span><span class="n">crit</span>
</span></span><span class="line"><span class="cl"><span class="n">FDR_df</span><span class="o">$</span><span class="n">adjust_manual</span>  <span class="o">&lt;-</span> <span class="nf">ifelse</span><span class="p">((</span><span class="n">FDR_df</span><span class="o">$</span><span class="n">p</span><span class="o">*</span><span class="n">m</span><span class="p">)</span><span class="o">/</span><span class="n">FDR_df</span><span class="o">$</span><span class="n">rank</span> <span class="o">&gt;</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="p">(</span><span class="n">FDR_df</span><span class="o">$</span><span class="n">p</span><span class="o">*</span><span class="n">m</span><span class="p">)</span><span class="o">/</span><span class="n">FDR_df</span><span class="o">$</span><span class="n">rank</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Then check if completely decreasing</span>
</span></span><span class="line"><span class="cl"><span class="nf">for</span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">FDR_df</span><span class="p">)</span><span class="o">:</span><span class="m">2</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="nf">if</span><span class="p">(</span><span class="n">FDR_df</span><span class="o">$</span><span class="n">adjust_manual[i]</span> <span class="o">&lt;</span> <span class="n">FDR_df</span><span class="o">$</span><span class="n">adjust_manual[i</span> <span class="o">-</span> <span class="m">1</span><span class="n">]</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">FDR_df</span><span class="o">$</span><span class="n">adjust_manual[i</span> <span class="o">-</span> <span class="m">1</span><span class="n">]</span> <span class="o">&lt;-</span> <span class="n">FDR_df</span><span class="o">$</span><span class="n">adjust_manual[i]</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">FDR_df</span><span class="o">$</span><span class="n">adjust_adjust</span>  <span class="o">&lt;-</span> <span class="nf">p.adjust</span><span class="p">(</span><span class="nf">sort</span><span class="p">(</span><span class="n">ps</span><span class="p">),</span> <span class="n">method</span> <span class="o">=</span> <span class="s">&#34;BH&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Display table</span>
</span></span><span class="line"><span class="cl"><span class="nf">kable</span><span class="p">(</span><span class="n">FDR_df</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div>




<table class="table table-striped table-bordered">
<thead>
<tr>
<th style="text-align:right">p</th>
<th style="text-align:right">rank</th>
<th style="text-align:right">crit</th>
<th style="text-align:left">lower</th>
<th style="text-align:right">adjust_manual</th>
<th style="text-align:right">adjust_adjust</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right">0.0010000</td>
<td style="text-align:right">1</td>
<td style="text-align:right">0.0045455</td>
<td style="text-align:left">TRUE</td>
<td style="text-align:right">0.0110000</td>
<td style="text-align:right">0.0110000</td>
</tr>
<tr>
<td style="text-align:right">0.0075637</td>
<td style="text-align:right">2</td>
<td style="text-align:right">0.0090909</td>
<td style="text-align:left">TRUE</td>
<td style="text-align:right">0.0416003</td>
<td style="text-align:right">0.0416003</td>
</tr>
<tr>
<td style="text-align:right">0.1600754</td>
<td style="text-align:right">3</td>
<td style="text-align:right">0.0136364</td>
<td style="text-align:left">FALSE</td>
<td style="text-align:right">0.3877979</td>
<td style="text-align:right">0.3877979</td>
</tr>
<tr>
<td style="text-align:right">0.1727596</td>
<td style="text-align:right">4</td>
<td style="text-align:right">0.0181818</td>
<td style="text-align:left">FALSE</td>
<td style="text-align:right">0.3877979</td>
<td style="text-align:right">0.3877979</td>
</tr>
<tr>
<td style="text-align:right">0.1762718</td>
<td style="text-align:right">5</td>
<td style="text-align:right">0.0227273</td>
<td style="text-align:left">FALSE</td>
<td style="text-align:right">0.3877979</td>
<td style="text-align:right">0.3877979</td>
</tr>
<tr>
<td style="text-align:right">0.2380772</td>
<td style="text-align:right">6</td>
<td style="text-align:right">0.0272727</td>
<td style="text-align:left">FALSE</td>
<td style="text-align:right">0.4364749</td>
<td style="text-align:right">0.4364749</td>
</tr>
<tr>
<td style="text-align:right">0.4092754</td>
<td style="text-align:right">7</td>
<td style="text-align:right">0.0318182</td>
<td style="text-align:left">FALSE</td>
<td style="text-align:right">0.5036225</td>
<td style="text-align:right">0.5036225</td>
</tr>
<tr>
<td style="text-align:right">0.4096089</td>
<td style="text-align:right">8</td>
<td style="text-align:right">0.0363636</td>
<td style="text-align:left">FALSE</td>
<td style="text-align:right">0.5036225</td>
<td style="text-align:right">0.5036225</td>
</tr>
<tr>
<td style="text-align:right">0.4120547</td>
<td style="text-align:right">9</td>
<td style="text-align:right">0.0409091</td>
<td style="text-align:left">FALSE</td>
<td style="text-align:right">0.5036225</td>
<td style="text-align:right">0.5036225</td>
</tr>
<tr>
<td style="text-align:right">0.6297573</td>
<td style="text-align:right">10</td>
<td style="text-align:right">0.0454545</td>
<td style="text-align:left">FALSE</td>
<td style="text-align:right">0.6927330</td>
<td style="text-align:right">0.6927330</td>
</tr>
<tr>
<td style="text-align:right">0.9008737</td>
<td style="text-align:right">11</td>
<td style="text-align:right">0.0500000</td>
<td style="text-align:left">FALSE</td>
<td style="text-align:right">0.9008737</td>
<td style="text-align:right">0.9008737</td>
</tr>
</tbody>
</table>

<h1 id="conclusion">Conclusion</h1>
<p>Overall, I have to say that despite having dealt with these kind of
questions &amp; problems for years only really playing around with the
equations in code helped me understand the concepts in deeper way.
Hopefully, other people might also find this somewhat useful.</p>
<h1 id="glossary">Glossary</h1>
<ul>
<li>Rank = Number of independent columns in matrix or the number of
dimensions in the output (if matrices are seen as transformations).</li>
<li>Full rank = Rank is as high as the number of columns.</li>
<li>FWE (rate) = “is the chance of one or more false positives anywhere in
the image.” (Poldrack et al., 2011, p. 117)</li>
<li>Bonferroni = A correction where simply
$\frac{\alpha}{number\ of\ tests}$ assuming the the tests are
independent. This is a method to correct FWE.</li>
<li>FDR = Expected proportion of voxels deemed significant that are false
positives.</li>
</ul>


  

  
  <hr>
  <footer>

  
    <section>
    <h4>Share</h4>
    <nav class="nav sharing-icons">
      <a class="nav-item" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fjaquent.github.io%2f2023%2f02%2funderstanding-the-basics-of-the-general-linear-model-glm-in-the-context-of-fmri%2f" title="Share on Facebook"><span class="fab fa-facebook-f fa-2x" aria-hidden="true"></span></a>
      <a class="nav-item" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fjaquent.github.io%2f2023%2f02%2funderstanding-the-basics-of-the-general-linear-model-glm-in-the-context-of-fmri%2f" title="Share on LinkedIn"><span class="fab fa-linkedin-in fa-2x" aria-hidden="true"></span></a>
      <a class="nav-item" href="https://twitter.com/intent/tweet?url=https%3a%2f%2fjaquent.github.io%2f2023%2f02%2funderstanding-the-basics-of-the-general-linear-model-glm-in-the-context-of-fmri%2f&amp;text=Understanding%20the%20basics%20of%20the%20general%20linear%20model%20%28GLM%29%20in%20the%20context%20of%20fMRI" title="Tweet this"><span class="fab fa-twitter fa-2x"></span></a>
    </nav>
  </section>

  

  
  </footer>
  

</article> 



        </div> <!-- /.blog-main -->

        <aside class="col-sm-3 ml-auto blog-sidebar">
  
  <section class="sidebar-module sidebar-module-inset">
    <h4>About</h4>
    <p dir="auto">The idea behind this notebook can be found <a href="/about/">here</a>.</p>
  </section>
  

  
        <section class="sidebar-module">
    <h4>Recent Posts</h4>
    <ol class="list-unstyled">


<li><a href="/2026/02/creating-actually-publication-ready-figures-for-journals-using-ggplot2/">Creating actually publication-ready figures for journals using <code>ggplot2</code></a></li>

<li><a href="/2025/06/visualise-your-surface-based-neuroimaging-data-on-flat-maps-using-ciftitools/">Visualise your surface-based neuroimaging data on flat maps using <code>ciftiTools</code></a></li>

<li><a href="/2023/10/running-large-simulations-on-a-desktop-computer-with-r-tips-tricks/">Running large simulations on a desktop computer with R (tips &amp; tricks)</a></li>

<li><a href="/2023/07/a-way-to-get-mni-coordinates-for-subcortical-voxels-of-a-cifti-file/">A way to get MNI coordinates for subcortical voxels of a CIFTI file</a></li>

<li><a href="/2023/02/understanding-the-basics-of-the-general-linear-model-glm-in-the-context-of-fmri/">Understanding the basics of the general linear model (GLM) in the context of fMRI</a></li>

    </ol>
  </section>

  

  
  <section class="sidebar-module">
    <h4>Links</h4>
    <ol class="list-unstyled">
      
      <li><a href="https://github.com/JAQuent/">My GitHub page</a></li>
      
    </ol>
  </section>
  

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
  <section class="sidebar-module">
    
        
        <h4>Categories</h4>
        <p>
            
            <a class="badge badge-secondary" href="/categories/experiments">experiments</a>
            
            <a class="badge badge-secondary" href="/categories/general">general</a>
            
            <a class="badge badge-secondary" href="/categories/tutorials">tutorials</a>
            
        </p>
        
    
        
        <h4>Tags</h4>
        <p>
            
            <a class="badge badge-secondary" href="/tags/bayesian-stats">bayesian-stats</a>
            
            <a class="badge badge-secondary" href="/tags/brms">brms</a>
            
            <a class="badge badge-secondary" href="/tags/cifti">cifti</a>
            
            <a class="badge badge-secondary" href="/tags/computing">computing</a>
            
            <a class="badge badge-secondary" href="/tags/data-visualisation">data-visualisation</a>
            
            <a class="badge badge-secondary" href="/tags/data-visualization">data-visualization</a>
            
            <a class="badge badge-secondary" href="/tags/figures">figures</a>
            
            <a class="badge badge-secondary" href="/tags/fmri">fmri</a>
            
            <a class="badge badge-secondary" href="/tags/ggplot2">ggplot2</a>
            
            <a class="badge badge-secondary" href="/tags/glm">glm</a>
            
            <a class="badge badge-secondary" href="/tags/hcp">hcp</a>
            
            <a class="badge badge-secondary" href="/tags/ijk">ijk</a>
            
            <a class="badge badge-secondary" href="/tags/json">json</a>
            
            <a class="badge badge-secondary" href="/tags/logistic-regression">logistic-regression</a>
            
            <a class="badge badge-secondary" href="/tags/matlab">matlab</a>
            
            <a class="badge badge-secondary" href="/tags/mixed-linear-models">mixed-linear-models</a>
            
            <a class="badge badge-secondary" href="/tags/mni">mni</a>
            
            <a class="badge badge-secondary" href="/tags/noveltyvr">noveltyvr</a>
            
            <a class="badge badge-secondary" href="/tags/parallelisation">parallelisation</a>
            
            <a class="badge badge-secondary" href="/tags/r">r</a>
            
            <a class="badge badge-secondary" href="/tags/schemavr">schemavr</a>
            
            <a class="badge badge-secondary" href="/tags/scientific-computing">scientific-computing</a>
            
            <a class="badge badge-secondary" href="/tags/sequential-design">sequential-design</a>
            
            <a class="badge badge-secondary" href="/tags/stats">stats</a>
            
            <a class="badge badge-secondary" href="/tags/textures">textures</a>
            
            <a class="badge badge-secondary" href="/tags/tutorial">tutorial</a>
            
            <a class="badge badge-secondary" href="/tags/u-shape">u-shape</a>
            
            <a class="badge badge-secondary" href="/tags/unity">unity</a>
            
            <a class="badge badge-secondary" href="/tags/unity3d">unity3d</a>
            
            <a class="badge badge-secondary" href="/tags/voxel-index-coordinates">voxel-index-coordinates</a>
            
        </p>
        
    
 </section>
</aside>


      </div> <!-- /.row -->
    </div> <!-- /.container -->
    

    
    <footer class="blog-footer">
      <p dir="auto">
      
      Blog template created by <a href="https://twitter.com/mdo">@mdo</a>, ported to Hugo by <a href='https://twitter.com/mralanorth'>@mralanorth</a>.
      
      </p>
      <p>
      <a href="#">Back to top</a>
      </p>
    </footer>
    

  </body>

</html>
